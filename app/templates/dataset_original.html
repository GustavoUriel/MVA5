{% extends "base.html" %}

{% block title %}{{ dataset.name }} - Microbiome Analysis Platform{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Header -->
    <div class="mb-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="{{ url_for('main.dashboard') }}">
                        <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item active">{{ dataset.name }}</li>
            </ol>
        </nav>
        
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <h1 class="h2 mb-2">
                    <i class="fas fa-folder-open me-2 text-primary"></i>
                    {{ dataset.name }}
                </h1>
                <div class="d-flex align-items-center gap-3">
                    <span class="badge bg-{{ 'success' if dataset.status == 'ready' else 'secondary' if dataset.status == 'draft' else 'warning' if dataset.status == 'processing' else 'danger' }} fs-6">
                        {{ dataset.status.title() }}
                    </span>
                    <small class="text-muted">
                        <i class="fas fa-calendar-alt me-1"></i>
                        Created {{ dataset.created_at.strftime('%B %d, %Y') }}
                    </small>
                    <small class="text-muted">
                        <i class="fas fa-edit me-1"></i>
                        Updated {{ dataset.updated_at.strftime('%B %d, %Y') }}
                    </small>
                </div>
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fas fa-cog"></i>
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#"><i class="fas fa-info-circle me-2"></i>Dataset Info</a></li>
                    <li><a class="dropdown-item" href="#"><i class="fas fa-edit me-2"></i>Rename Dataset</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="#" onclick="showDeleteConfirmation()">
                        <i class="fas fa-trash me-2"></i>Delete Dataset
                    </a></li>
                </ul>
            </div>
        </div>
        
        {% if dataset.description %}
            <p class="text-muted mt-2">{{ dataset.description }}</p>
        {% endif %}
    </div>

    <!-- Overview Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-primary">
                <div class="card-body text-center">
                    <i class="fas fa-file fa-2x text-primary mb-2"></i>
                    <h5 class="card-title">{{ dataset.file_count }}</h5>
                    <p class="card-text text-muted mb-0">Files</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-info">
                <div class="card-body text-center">
                    <i class="fas fa-hdd fa-2x text-info mb-2"></i>
                    <h5 class="card-title">
                        {% if dataset.total_size %}
                            {{ "%.1f"|format(dataset.total_size / 1024 / 1024) }} MB
                        {% else %}
                            0 MB
                        {% endif %}
                    </h5>
                    <p class="card-text text-muted mb-0">Total Size</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-success">
                <div class="card-body text-center">
                    <i class="fas fa-chart-line fa-2x text-success mb-2"></i>
                    <h5 class="card-title">0</h5>
                    <p class="card-text text-muted mb-0">Analyses</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-warning">
                <div class="card-body text-center">
                    <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                    <h5 class="card-title">
                        {% set age_delta = dataset.updated_at - dataset.created_at %}
                        {% if age_delta.days < 7 %}
                            {% if age_delta.days > 0 %}
                                {{ age_delta.days }}d {{ (age_delta.seconds // 3600) }}h
                            {% else %}
                                {{ (age_delta.seconds // 3600) }}h {{ ((age_delta.seconds % 3600) // 60) }}m
                            {% endif %}
                        {% else %}
                            {{ age_delta.days }}d
                        {% endif %}
                    </h5>
                    <p class="card-text text-muted mb-0">Age</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Tabs -->
    <div class="card">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" id="datasetTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="files-tab" data-bs-toggle="tab" data-bs-target="#files" type="button" role="tab">
                        <i class="fas fa-folder me-2"></i>Files
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="analysis-tab" data-bs-toggle="tab" data-bs-target="#analysis" type="button" role="tab">
                        <i class="fas fa-chart-line me-2"></i>Analysis
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab">
                        <i class="fas fa-file-alt me-2"></i>Reports
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
                        <i class="fas fa-cog me-2"></i>Settings
                    </button>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content" id="datasetTabsContent">
                <!-- Files Tab -->
                <div class="tab-pane fade show active" id="files" role="tabpanel">
                    <!-- Upload Progress -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <h6 class="mb-0">Dataset Completion</h6>
                            <span class="badge bg-{{ 'success' if dataset.is_complete else 'warning' }}">
                                {{ dataset.completion_percentage }}% Complete
                            </span>
                        </div>
                        <div class="progress mb-3">
                            <div class="progress-bar bg-{{ 'success' if dataset.is_complete else 'warning' }}" 
                                 role="progressbar" 
                                 style="width: {{ dataset.completion_percentage }}%">
                            </div>
                        </div>
                        <div class="row text-center">
                            <div class="col-md-4">
                                <div class="d-flex align-items-center justify-content-center">
                                    <i class="fas fa-{{ 'check-circle text-success' if dataset.patients_file_uploaded else 'times-circle text-muted' }} me-2"></i>
                                    <span class="{{ 'text-success' if dataset.patients_file_uploaded else 'text-muted' }}">
                                        Patients Data
                                    </span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-center justify-content-center">
                                    <i class="fas fa-{{ 'check-circle text-success' if dataset.taxonomy_file_uploaded else 'times-circle text-muted' }} me-2"></i>
                                    <span class="{{ 'text-success' if dataset.taxonomy_file_uploaded else 'text-muted' }}">
                                        Taxonomy Data
                                    </span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-center justify-content-center">
                                    <i class="fas fa-{{ 'check-circle text-success' if dataset.bracken_file_uploaded else 'times-circle text-muted' }} me-2"></i>
                                    <span class="{{ 'text-success' if dataset.bracken_file_uploaded else 'text-muted' }}">
                                        Bracken Results
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Upload Interface -->
                    <div class="row mb-4">
                        <!-- Patients Data Upload -->
                        <div class="col-md-4">
                            <div class="card h-100" id="patients-upload-card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-user-injured me-2 text-primary"></i>
                                        Patients Data
                                    </h6>
                                </div>
                                <div class="card-body" id="patients-upload-body">
                                    <div class="upload-section" data-file-type="patients">
                                        <!-- File Upload -->
                                        <div class="mb-3">
                                            <label class="form-label">Upload File</label>
                                            <input type="file" class="form-control" accept=".csv,.tsv,.txt" 
                                                   name="file" data-file-type="patients" data-upload-method="file">
                                            <div class="form-text">Supported formats: CSV, TSV, TXT</div>
                                        </div>
                                        
                                        <button type="button" class="btn btn-primary w-100 upload-btn" 
                                                data-file-type="patients">
                                            <i class="fas fa-upload me-2"></i>
                                            Upload Patients Data
                                        </button>
                                        
                                        <!-- Status/Results Box -->
                                        <div class="mt-3" id="patients-status-container">
                                            <div class="alert alert-light border" role="alert" id="patients-status" style="padding: 0.75rem 1rem;">
                                                {% if dataset.patients_file_uploaded %}
                                                    <i class="fas fa-check-circle text-success me-2"></i>
                                                    <strong>File uploaded successfully</strong>
                                                {% else %}
                                                    <i class="fas fa-info-circle text-muted me-2"></i>
                                                    <span class="text-muted">No actions yet</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Taxonomy Data Upload -->
                        <div class="col-md-4">
                            <div class="card h-100" id="taxonomy-upload-card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-sitemap me-2 text-info"></i>
                                        Taxonomy Data
                                    </h6>
                                </div>
                                <div class="card-body" id="taxonomy-upload-body">
                                    <div class="upload-section" data-file-type="taxonomy">
                                        <!-- File Upload -->
                                        <div class="mb-3">
                                            <label class="form-label">Upload File</label>
                                            <input type="file" class="form-control" accept=".csv,.tsv,.txt" 
                                                   name="file" data-file-type="taxonomy" data-upload-method="file">
                                            <div class="form-text">Supported formats: CSV, TSV, TXT</div>
                                        </div>
                                        
                                        <button type="button" class="btn btn-info w-100 upload-btn" 
                                                data-file-type="taxonomy">
                                            <i class="fas fa-upload me-2"></i>
                                            Upload Taxonomy Data
                                        </button>
                                        
                                        <!-- Status/Results Box -->
                                        <div class="mt-3" id="taxonomy-status-container">
                                            <div class="alert alert-light border" role="alert" id="taxonomy-status" style="padding: 0.75rem 1rem;">
                                                {% if dataset.taxonomy_file_uploaded %}
                                                    <i class="fas fa-check-circle text-success me-2"></i>
                                                    <strong>File uploaded successfully</strong>
                                                {% else %}
                                                    <i class="fas fa-info-circle text-muted me-2"></i>
                                                    <span class="text-muted">No actions yet</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bracken Results Upload -->
                        <div class="col-md-4">
                            <div class="card h-100" id="bracken-upload-card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-chart-bar me-2 text-success"></i>
                                        Bracken Results
                                    </h6>
                                </div>
                                <div class="card-body" id="bracken-upload-body">
                                    <div class="upload-section" data-file-type="bracken">
                                        <!-- File Upload -->
                                        <div class="mb-3">
                                            <label class="form-label">Upload File</label>
                                            <input type="file" class="form-control" accept=".csv,.tsv,.txt" 
                                                   name="file" data-file-type="bracken" data-upload-method="file">
                                            <div class="form-text">Supported formats: CSV, TSV, TXT</div>
                                        </div>
                                        
                                        <button type="button" class="btn btn-success w-100 upload-btn" 
                                                data-file-type="bracken">
                                            <i class="fas fa-upload me-2"></i>
                                            Upload Bracken Results
                                        </button>
                                        
                                        <!-- Status/Results Box -->
                                        <div class="mt-3" id="bracken-status-container">
                                            <div class="alert alert-light border" role="alert" id="bracken-status" style="padding: 0.75rem 1rem;">
                                                {% if dataset.bracken_file_uploaded %}
                                                    <i class="fas fa-check-circle text-success me-2"></i>
                                                    <strong>File uploaded successfully</strong>
                                                {% else %}
                                                    <i class="fas fa-info-circle text-muted me-2"></i>
                                                    <span class="text-muted">No actions yet</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Data Statistics and Sanitization Section -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-chart-bar me-2 text-info"></i>
                                Data Statistics & Sanitization
                            </h6>
                        </div>
                        <div class="card-body">
                            <div id="dataStatsSection">
                                <div class="text-center py-4">
                                    <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                                    <p class="mt-2 text-muted">Analyzing data...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Uploaded Files Table -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-folder me-2"></i>
                                Uploaded Files
                            </h6>
                        </div>
                        <div class="card-body">
                            <div id="filesTable">
                                <div class="text-center py-4">
                                    <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                                    <p class="mt-2 text-muted">Loading files...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analysis Tab -->
                <div class="tab-pane fade" id="analysis" role="tabpanel">
                    <!-- Analysis List Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="d-flex align-items-center justify-content-between mb-3">
                                <div>
                                    <h5 class="mb-1">
                                        <i class="fas fa-chart-line me-2 text-primary"></i>
                                        Analysis Management
                                    </h5>
                                    <p class="text-muted mb-0">Create, manage, and run microbiome analyses</p>
                                </div>
                                <button type="button" class="btn btn-primary" onclick="createNewAnalysis()">
                                    <i class="fas fa-plus me-1"></i>New Analysis
                                </button>
                            </div>
                            
                            <!-- Analysis List -->
                            <div class="card">
                                <div class="card-header">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <h6 class="mb-0">
                                            <i class="fas fa-list me-2"></i>
                                            Existing Analyses
                                        </h6>
                                        <div class="btn-group btn-group-sm">
                                            <button type="button" class="btn btn-outline-secondary" onclick="refreshAnalysisList()">
                                                <i class="fas fa-sync-alt me-1"></i>Refresh
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="analysisListContainer">
                                        <!-- Analysis list will be populated here -->
                                        <div class="text-center py-4" id="noAnalysesState">
                                            <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                                            <h6 class="text-muted mb-2">No Analyses Created Yet</h6>
                                            <p class="text-muted mb-3">Create your first analysis to get started with microbiome data exploration.</p>
                                            <button type="button" class="btn btn-primary" onclick="createNewAnalysis()">
                                                <i class="fas fa-plus me-1"></i>Create First Analysis
                                            </button>
                                        </div>
                                        
                                        <!-- Analysis Table (hidden by default) -->
                                        <div id="analysisTable" style="display: none;">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Name</th>
                                                            <th>Created</th>
                                                            <th>Modified</th>
                                                            <th>Size</th>
                                                            <th>Last Run</th>
                                                            <th>Patients</th>
                                                            <th>Status</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="analysisTableBody">
                                                        <!-- Analysis rows will be populated here -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Analysis Editor Section -->
                    <div class="row" id="analysisEditorSection" style="display: none;">
                        <div class="col-12">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <h6 class="mb-0">
                                            <i class="fas fa-edit me-2"></i>
                                            <span id="editorTitle">New Analysis</span>
                                        </h6>
                                        <div class="btn-group">
                                                                                        <button type="button" class="btn btn-light btn-sm" onclick="saveAnalysis()">
                                                                                            <i class="fas fa-save me-1"></i>Save
                                                                                        </button>
                                                                                        <button type="button" class="btn btn-outline-light btn-sm" onclick="cancelAnalysisEdit()">
                                                                                            <i class="fas fa-times me-1"></i>Close
                                                                                        </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- Analysis Name -->
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="analysisName" class="form-label">Analysis Name</label>
                                            <input type="text" class="form-control" id="analysisName" placeholder="Enter analysis name...">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="analysisDescription" class="form-label">Description</label>
                                            <input type="text" class="form-control" id="analysisDescription" placeholder="Brief description...">
                                        </div>
                                    </div>
                                    
                                    <!-- Editor Tabs -->
                                    <ul class="nav nav-tabs" id="analysisEditorTabs" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="datasources-editor-tab" data-bs-toggle="tab" data-bs-target="#datasources-editor" type="button" role="tab">
                                                <i class="fas fa-layer-group me-2"></i>Data Sources
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="config-editor-tab" data-bs-toggle="tab" data-bs-target="#config-editor" type="button" role="tab">
                                                <i class="fas fa-sliders-h me-2"></i>Analysis Config
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="reports-config-tab" data-bs-toggle="tab" data-bs-target="#reports-config" type="button" role="tab">
                                                <i class="fas fa-file-alt me-2"></i>Report Config
                                            </button>
                                        </li>
                                    </ul>
                                    
                                    <div class="tab-content mt-3" id="analysisEditorTabsContent">
                                        <!-- Data Sources Editor Tab -->
                                        <div class="tab-pane fade show active" id="datasources-editor" role="tabpanel">
                                            <!-- File Selection Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-files me-2"></i>
                                        Select Data Files
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <!-- Patient File Selection -->
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="editorPatientFileSelect" class="form-label">
                                                    <i class="fas fa-user-injured text-primary me-2"></i>
                                                    Patient Data File
                                                </label>
                                                <select class="form-select" id="editorPatientFileSelect" onchange="window.analysisManager && window.analysisManager.validateAnalysisEditor && window.analysisManager.validateAnalysisEditor()">
                                                    <option value="">Select patient file...</option>
                                                    <!-- Options will be populated dynamically -->
                                                </select>
                                                <div class="form-text">Choose the patient metadata file for analysis</div>
                                            </div>
                                        </div>

                                        <!-- Taxonomy File Selection -->
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="editorTaxonomyFileSelect" class="form-label">
                                                    <i class="fas fa-sitemap text-info me-2"></i>
                                                    Taxonomy Data File
                                                </label>
                                                <select class="form-select" id="editorTaxonomyFileSelect" onchange="window.analysisManager && window.analysisManager.validateAnalysisEditor && window.analysisManager.validateAnalysisEditor()">
                                                    <option value="">Select taxonomy file...</option>
                                                    <!-- Options will be populated dynamically -->
                                                </select>
                                                <div class="form-text">Choose the taxonomy reference file</div>
                                            </div>
                                        </div>

                                        <!-- Bracken File Selection -->
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="editorBrackenFileSelect" class="form-label">
                                                    <i class="fas fa-chart-bar text-success me-2"></i>
                                                    Bracken Results File
                                                </label>
                                                <select class="form-select" id="editorBrackenFileSelect" onchange="window.analysisManager && window.analysisManager.validateAnalysisEditor && window.analysisManager.validateAnalysisEditor()">
                                                    <option value="">Select bracken file...</option>
                                                    <!-- Options will be populated dynamically -->
                                                </select>
                                                <div class="form-text">Choose the bracken abundance data file</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Column Groups Selection Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <h6 class="mb-0">
                                            <i class="fas fa-layer-group me-2"></i>
                                            Patient Data Column Groups
                                        </h6>
                                        <div class="btn-group btn-group-sm">
                                            <button type="button" class="btn btn-outline-primary" onclick="selectAllColumnGroups()">
                                                <i class="fas fa-check-all me-1"></i>Select All
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="clearAllColumnGroups()">
                                                <i class="fas fa-times me-1"></i>Clear All
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted mb-3">Select which groups of patient data columns to include in your analysis:</p>
                                    <div class="row" id="columnGroupsContainer">
                                        <!-- Column groups will be dynamically populated here -->
                                    </div>
                                    
                                    <!-- Selection Summary -->
                                    <div class="mt-3 p-3 bg-light rounded">
                                        <div class="row align-items-center">
                                            <div class="col-md-8">
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-info-circle text-primary me-2"></i>
                                                    <span id="selectionSummary">No column groups selected</span>
                                                </div>
                                            </div>
                                            <div class="col-md-4 text-end">
                                                <span class="badge bg-primary" id="totalColumnsCount">0 total columns</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                            <!-- Bracken Time Point Selection -->
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="editorBrackenTimePointSelect" class="form-label">
                                                        <i class="fas fa-timeline text-warning me-2"></i>
                                                        Bracken Time Point
                                                    </label>
                                                    <select class="form-select" id="editorBrackenTimePointSelect" onchange="window.analysisManager && window.analysisManager.updateTimePointDescription && window.analysisManager.updateTimePointDescription()">
                                                        <option value="">Choose time point...</option>
                                                        <!-- Options will be populated dynamically -->
                                                    </select>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Run Analysis</label>
                                                    <div>
                                                        <button type="button" class="btn btn-primary w-100" onclick="window.analysisManager && window.analysisManager.runAnalysisFromEditor && window.analysisManager.runAnalysisFromEditor()">
                                                            <i class="fas fa-play me-1"></i>Run Analysis
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Analysis Config Editor Tab -->
                                        <div class="tab-pane fade" id="config-editor" role="tabpanel">
                                            <!-- Analysis Configuration Content -->
                                            <div class="row mb-3">
                                                <div class="col-12">
                                                    <h6 class="mb-3">
                                                        <i class="fas fa-flask me-2"></i>
                                                        Analysis Type
                                                    </h6>
                                                    <div class="row">
                                                        <div class="col-md-4">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="radio" name="editorAnalysisType" id="editorAlphaDiv" value="alpha_diversity" checked>
                                                                <label class="form-check-label" for="editorAlphaDiv">
                                                                    <strong>Alpha Diversity</strong><br>
                                                                    <small class="text-muted">Within-sample diversity analysis</small>
                                                                </label>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="radio" name="editorAnalysisType" id="editorBetaDiv" value="beta_diversity">
                                                                <label class="form-check-label" for="editorBetaDiv">
                                                                    <strong>Beta Diversity</strong><br>
                                                                    <small class="text-muted">Between-sample diversity analysis</small>
                                                                </label>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="radio" name="editorAnalysisType" id="editorDiffAbund" value="differential_abundance">
                                                                <label class="form-check-label" for="editorDiffAbund">
                                                                    <strong>Differential Abundance</strong><br>
                                                                    <small class="text-muted">Compare abundances between groups</small>
                                                                </label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Analysis Parameters -->
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <h6 class="mb-3">
                                                        <i class="fas fa-cogs me-2"></i>
                                                        General Parameters
                                                    </h6>
                                                    <div class="mb-3">
                                                        <label for="editorTaxonomicLevel" class="form-label">Taxonomic Level</label>
                                                        <select class="form-select" id="editorTaxonomicLevel">
                                                            <option value="species" selected>Species</option>
                                                            <option value="genus">Genus</option>
                                                            <option value="family">Family</option>
                                                            <option value="order">Order</option>
                                                            <option value="class">Class</option>
                                                            <option value="phylum">Phylum</option>
                                                        </select>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="editorMinAbundance" class="form-label">Minimum Abundance Threshold</label>
                                                        <div class="input-group">
                                                            <input type="number" class="form-control" id="editorMinAbundance" value="0.001" step="0.001" min="0" max="1">
                                                            <span class="input-group-text">%</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <h6 class="mb-3">
                                                        <i class="fas fa-chart-bar me-2"></i>
                                                        Statistical Parameters
                                                    </h6>
                                                    <div class="mb-3">
                                                        <label for="editorStatisticalMethod" class="form-label">Statistical Method</label>
                                                        <select class="form-select" id="editorStatisticalMethod">
                                                            <option value="wilcoxon" selected>Wilcoxon Rank-Sum Test</option>
                                                            <option value="ttest">T-Test</option>
                                                            <option value="kruskal">Kruskal-Wallis Test</option>
                                                            <option value="anova">ANOVA</option>
                                                        </select>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="editorPValueCorrection" class="form-label">P-value Correction</label>
                                                        <select class="form-select" id="editorPValueCorrection">
                                                            <option value="fdr_bh" selected>Benjamini-Hochberg (FDR)</option>
                                                            <option value="bonferroni">Bonferroni</option>
                                                            <option value="holm">Holm-Sidak</option>
                                                            <option value="none">None</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Reports Config Editor Tab -->
                                        <div class="tab-pane fade" id="reports-config" role="tabpanel">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <h6 class="mb-3">
                                                        <i class="fas fa-file-pdf me-2"></i>
                                                        Report Format
                                                    </h6>
                                                    <div class="mb-3">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="reportPDF" checked>
                                                            <label class="form-check-label" for="reportPDF">
                                                                PDF Report
                                                            </label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="reportHTML">
                                                            <label class="form-check-label" for="reportHTML">
                                                                HTML Report
                                                            </label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="reportCSV">
                                                            <label class="form-check-label" for="reportCSV">
                                                                CSV Data Export
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <h6 class="mb-3">
                                                        <i class="fas fa-chart-pie me-2"></i>
                                                        Report Content
                                                    </h6>
                                                    <div class="mb-3">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="includeSummary" checked>
                                                            <label class="form-check-label" for="includeSummary">
                                                                Summary Statistics
                                                            </label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="includePlots" name="includePlots" checked>
                                                            <label class="form-check-label" for="includePlots">
                                                                Visualization Plots
                                                            </label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="includeRawData" name="includeRawData">
                                                            <label class="form-check-label" for="includeRawData">
                                                                Raw Data Tables
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Editor Action Buttons -->
                                    <div class="border-top pt-3 mt-3">
                                        <div class="d-flex justify-content-end">
                                            <div class="btn-group">
                                                <button type="button" class="btn btn-outline-secondary" onclick="cancelAnalysisEdit()">
                                                    <i class="fas fa-times me-1"></i>Cancel
                                                </button>
                                                <button type="button" class="btn btn-success" onclick="saveAnalysis()">
                                                    <i class="fas fa-save me-1"></i>Save
                                                </button>
                                                <button type="button" class="btn btn-primary" onclick="window.analysisManager && window.analysisManager.runAnalysisFromEditor && window.analysisManager.runAnalysisFromEditor()">
                                                    <i class="fas fa-play me-1"></i>Run Analysis
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports Tab -->
                <div class="tab-pane fade" id="reports" role="tabpanel">
                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex align-items-center justify-content-between mb-4">
                                <div>
                                    <h5 class="mb-1">
                                        <i class="fas fa-file-alt me-2 text-info"></i>
                                        Analysis Reports
                                    </h5>
                                    <p class="text-muted mb-0">View, download, and manage your generated analysis reports</p>
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-outline-primary" disabled>
                                        <i class="fas fa-plus me-1"></i>Generate New Report
                                    </button>
                                    <button type="button" class="btn btn-outline-success" disabled>
                                        <i class="fas fa-download me-1"></i>Download All
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Reports Filter and Search -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-md-4">
                                            <div class="input-group">
                                                <span class="input-group-text">
                                                    <i class="fas fa-search"></i>
                                                </span>
                                                <input type="text" class="form-control" placeholder="Search reports..." id="reportSearch">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <select class="form-select" id="reportTypeFilter">
                                                <option value="all">All Report Types</option>
                                                <option value="alpha_diversity">Alpha Diversity</option>
                                                <option value="beta_diversity">Beta Diversity</option>
                                                <option value="differential_abundance">Differential Abundance</option>
                                                <option value="summary">Summary Reports</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <select class="form-select" id="reportStatusFilter">
                                                <option value="all">All Statuses</option>
                                                <option value="completed">Completed</option>
                                                <option value="generating">Generating</option>
                                                <option value="failed">Failed</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <button type="button" class="btn btn-outline-secondary w-100" onclick="clearReportFilters()">
                                                <i class="fas fa-times me-1"></i>Clear
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Reports List -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <h6 class="mb-0">
                                            <i class="fas fa-list me-2"></i>
                                            Generated Reports
                                        </h6>
                                        <span class="badge bg-secondary" id="reportCount">0 reports</span>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="reportsContainer">
                                        <!-- No Reports State -->
                                        <div class="text-center py-5" id="noReportsState">
                                            <i class="fas fa-file-alt fa-4x text-muted mb-3"></i>
                                            <h5 class="text-muted mb-3">No Reports Generated Yet</h5>
                        <p class="text-muted mb-4">
                                                Once you run analyses, generated reports will appear here.<br>
                                                You can download, view, or share your analysis results.
                                            </p>
                                            <div class="row justify-content-center">
                                                <div class="col-md-8">
                                                    <div class="card border-dashed">
                                                        <div class="card-body">
                                                            <h6 class="card-title">
                                                                <i class="fas fa-lightbulb text-warning me-2"></i>
                                                                Quick Start Guide
                                                            </h6>
                                                            <ol class="text-start mb-0">
                                                                <li class="mb-2">Upload your data files in the <strong>Files</strong> tab</li>
                                                                <li class="mb-2">Select data sources in the <strong>Data Sources</strong> tab</li>
                                                                <li class="mb-2">Configure analysis parameters in the <strong>Analysis Config</strong> tab</li>
                                                                <li class="mb-2">Run your analysis in the <strong>Analysis</strong> tab</li>
                                                                <li>Reports will be automatically generated and listed here</li>
                                                            </ol>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mt-4">
                                                <button type="button" class="btn btn-primary me-2" onclick="goToTab('files-tab')">
                                                    <i class="fas fa-upload me-1"></i>Start with File Upload
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary" onclick="goToTab('analysis-tab')">
                                                    <i class="fas fa-chart-line me-1"></i>Go to Analysis
                        </button>
                                            </div>
                                        </div>

                                        <!-- Reports List (hidden by default) -->
                                        <div id="reportsList" style="display: none;">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Report Name</th>
                                                            <th>Type</th>
                                                            <th>Status</th>
                                                            <th>Generated</th>
                                                            <th>Size</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="reportsTableBody">
                                                        <!-- Reports will be dynamically inserted here -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sample Reports (for demonstration) -->
                    <div class="row mt-4" id="sampleReportsSection" style="display: none;">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-eye me-2"></i>
                                        Report Preview
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <!-- Sample Alpha Diversity Report -->
                                        <div class="col-md-6 mb-3">
                                            <div class="card border-primary h-100">
                                                <div class="card-header bg-primary text-white">
                                                    <h6 class="mb-0">
                                                        <i class="fas fa-chart-area me-2"></i>
                                                        Alpha Diversity Analysis
                                                    </h6>
                                                </div>
                                                <div class="card-body">
                                                    <div class="row text-center mb-3">
                                                        <div class="col-4">
                                                            <div class="h5 text-primary">156</div>
                                                            <small class="text-muted">Samples</small>
                                                        </div>
                                                        <div class="col-4">
                                                            <div class="h5 text-primary">3.45</div>
                                                            <small class="text-muted">Avg Shannon</small>
                                                        </div>
                                                        <div class="col-4">
                                                            <div class="h5 text-primary">0.02</div>
                                                            <small class="text-muted">P-value</small>
                                                        </div>
                                                    </div>
                                                    <div class="text-center">
                                                        <span class="badge bg-primary">Completed</span>
                                                        <span class="badge bg-light text-dark ms-2">2.3 MB</span>
                                                    </div>
                                                    <div class="mt-3">
                                                        <button class="btn btn-sm btn-outline-primary me-1" disabled>
                                                            <i class="fas fa-eye"></i> View
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-success" disabled>
                                                            <i class="fas fa-download"></i> Download
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Sample Beta Diversity Report -->
                                        <div class="col-md-6 mb-3">
                                            <div class="card border-info h-100">
                                                <div class="card-header bg-info text-white">
                                                    <h6 class="mb-0">
                                                        <i class="fas fa-project-diagram me-2"></i>
                                                        Beta Diversity Analysis
                                                    </h6>
                                                </div>
                                                <div class="card-body">
                                                    <div class="row text-center mb-3">
                                                        <div class="col-4">
                                                            <div class="h5 text-info">PCoA</div>
                                                            <small class="text-muted">Method</small>
                                                        </div>
                                                        <div class="col-4">
                                                            <div class="h5 text-info">42%</div>
                                                            <small class="text-muted">PC1 Var</small>
                                                        </div>
                                                        <div class="col-4">
                                                            <div class="h5 text-info">0.001</div>
                                                            <small class="text-muted">PERMANOVA</small>
                                                        </div>
                                                    </div>
                                                    <div class="text-center">
                                                        <span class="badge bg-warning">Generating</span>
                                                        <span class="badge bg-light text-dark ms-2">~ 4.1 MB</span>
                                                    </div>
                                                    <div class="mt-3">
                                                        <button class="btn btn-sm btn-outline-info me-1" disabled>
                                                            <i class="fas fa-spinner fa-spin"></i> Processing
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-secondary" disabled>
                                                            <i class="fas fa-times"></i> Cancel
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Reports are automatically generated after running analyses
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-outline-secondary" onclick="goToTab('analysis-tab')">
                                        <i class="fas fa-arrow-left me-1"></i>Back to Analysis
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="goToTab('settings-tab')">
                                        <i class="fas fa-cog me-1"></i>Settings
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div class="tab-pane fade" id="settings" role="tabpanel">
                    <form>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="datasetName" class="form-label">Dataset Name</label>
                                    <input type="text" class="form-control" id="datasetName" value="{{ dataset.name }}">
                                </div>
                                <div class="mb-3">
                                    <label for="datasetDescription" class="form-label">Description</label>
                                    <textarea class="form-control" id="datasetDescription" rows="4">{{ dataset.description or '' }}</textarea>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Dataset Status</label>
                                    <select class="form-select">
                                        <option value="draft" {{ 'selected' if dataset.status == 'draft' else '' }}>Draft</option>
                                        <option value="ready" {{ 'selected' if dataset.status == 'ready' else '' }}>Ready</option>
                                        <option value="processing" {{ 'selected' if dataset.status == 'processing' else '' }}>Processing</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Privacy Settings</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="privacy" id="private" checked>
                                        <label class="form-check-label" for="private">
                                            <i class="fas fa-lock me-1"></i>Private (only you)
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="privacy" id="shared" disabled>
                                        <label class="form-check-label text-muted" for="shared">
                                            <i class="fas fa-users me-1"></i>Shared (coming soon)
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="border-top pt-3">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-save me-1"></i>Save Changes
                            </button>
                            <button type="button" class="btn btn-outline-secondary">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Dataset Confirmation Modal -->
<div class="modal fade" id="deleteDatasetModal" tabindex="-1" aria-labelledby="deleteDatasetModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteDatasetModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Delete Dataset
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <h6 class="alert-heading">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Warning: This action cannot be undone!
                    </h6>
                    <p class="mb-2">You are about to delete the dataset <strong>"{{ dataset.name }}"</strong> and all its associated data:</p>
                    <ul class="mb-3">
                        <li><strong>{{ dataset.file_count }}</strong> uploaded files</li>
                        <li><strong>{{ "%.1f"|format(dataset.total_size / 1024 / 1024) if dataset.total_size else 0 }} MB</strong> of data</li>
                        <li>All analysis results and metadata</li>
                    </ul>
                    <p class="mb-0"><strong>This action is permanent and cannot be reversed.</strong></p>
                </div>
                
                <div class="mb-3">
                    <label for="deleteConfirmation" class="form-label">
                        To confirm deletion, please type <code>delete</code> in the box below:
                    </label>
                    <input type="text" class="form-control" id="deleteConfirmation" 
                           placeholder="Type 'delete' to confirm" 
                           oninput="checkDeleteConfirmation()">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" disabled onclick="deleteDataset()">
                    <i class="fas fa-trash me-1"></i>Delete Dataset
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Global variables and functions
const datasetId = {{ dataset.id }};

// Data Statistics and Sanitization Functions
window.loadDataStats = function() {
    const statsSection = document.getElementById('dataStatsSection');
    if (!statsSection) {
        console.error('Data stats section not found');
        return;
    }
    
    fetch(`/dataset/${datasetId}/data-stats`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayDataStats(data.stats);
            } else {
                showDataStatsError(data.error);
            }
        })
        .catch(error => {
            console.error('Error loading data stats:', error);
            showDataStatsError('Failed to load data statistics');
        });
}

window.displayDataStats = function(stats) {
    // IMPORTANT: This function only modifies the dataStatsSection
    // It should NEVER interfere with the upload cards which have specific IDs
    const statsSection = document.getElementById('dataStatsSection');
    
    let html = '<div class="row">';
    
    // Patients Data Stats
    if (stats.patients && Object.keys(stats.patients).length > 0) {
        html += `
            <div class="col-md-4">
                <div class="card border-primary h-100">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="fas fa-user-injured me-2"></i>Patients Data</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center mb-3">
                            <div class="col-6">
                                <div class="h4 text-primary">${stats.patients.total_rows || 0}</div>
                                <small class="text-muted">Total Rows</small>
                            </div>
                            <div class="col-6">
                                <div class="h4 text-primary">${stats.patients.unique_patients || 0}</div>
                                <small class="text-muted">Unique Patients</small>
                            </div>
                        </div>
                        <div class="small text-muted mb-3">
                            <div>Columns: ${stats.patients.total_columns || 0}</div>
                            ${stats.patients.missing_patient_ids > 0 ? `<div class="text-warning">Missing IDs: ${stats.patients.missing_patient_ids}</div>` : ''}
                            ${stats.patients.duplicate_patient_ids > 0 ? `<div class="text-danger">Duplicate IDs: ${stats.patients.duplicate_patient_ids}</div>` : ''}
                        </div>
                        ${getSanitizationButtons('patients', stats.patients, stats.sanitization_needed)}
                    </div>
                </div>
            </div>
        `;
    }
    
    // Taxonomy Data Stats
    if (stats.taxonomy && Object.keys(stats.taxonomy).length > 0) {
        html += `
            <div class="col-md-4">
                <div class="card border-info h-100">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0"><i class="fas fa-sitemap me-2"></i>Taxonomy Data</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center mb-3">
                            <div class="col-6">
                                <div class="h4 text-info">${stats.taxonomy.total_rows || 0}</div>
                                <small class="text-muted">Total Rows</small>
                            </div>
                            <div class="col-6">
                                <div class="h4 text-info">${stats.taxonomy.unique_taxonomies || 0}</div>
                                <small class="text-muted">Unique Taxonomies</small>
                            </div>
                        </div>
                        <div class="small text-muted mb-3">
                            <div>Columns: ${stats.taxonomy.total_columns || 0}</div>
                            ${stats.taxonomy.missing_taxonomy_ids > 0 ? `<div class="text-warning">Missing IDs: ${stats.taxonomy.missing_taxonomy_ids}</div>` : ''}
                            ${stats.taxonomy.duplicate_taxonomy_ids > 0 ? `<div class="text-danger">Duplicate IDs: ${stats.taxonomy.duplicate_taxonomy_ids}</div>` : ''}
                        </div>
                        ${getSanitizationButtons('taxonomy', stats.taxonomy, stats.sanitization_needed)}
                    </div>
                </div>
            </div>
        `;
    }
    
    // Bracken Results Stats
    if (stats.bracken && Object.keys(stats.bracken).length > 0) {
        html += `
            <div class="col-md-4">
                <div class="card border-success h-100">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0"><i class="fas fa-dna me-2"></i>Bracken Results</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center mb-3">
                            <div class="col-6">
                                <div class="h4 text-success">${stats.bracken.total_rows || 0}</div>
                                <small class="text-muted">Total Rows</small>
                            </div>
                            <div class="col-6">
                                <div class="h4 text-success">${stats.bracken.unique_taxonomies || 0}</div>
                                <small class="text-muted">Unique Taxonomies</small>
                            </div>
                        </div>
                        <div class="small text-muted mb-3">
                            <div>Columns: ${stats.bracken.total_columns || 0}</div>
                            <div>Patient Samples: ${stats.bracken.patient_columns ? stats.bracken.patient_columns.length : 0}</div>
                            ${stats.bracken.missing_taxonomy_ids > 0 ? `<div class="text-warning">Missing IDs: ${stats.bracken.missing_taxonomy_ids}</div>` : ''}
                            ${stats.bracken.duplicate_taxonomy_ids > 0 ? `<div class="text-danger">Duplicate IDs: ${stats.bracken.duplicate_taxonomy_ids}</div>` : ''}
                        </div>
                        ${getSanitizationButtons('bracken', stats.bracken, stats.sanitization_needed)}
                    </div>
                </div>
            </div>
        `;
    }
    
    html += '</div>';
    
    // Cross-reference analysis
    if (stats.cross_references && Object.keys(stats.cross_references).length > 0) {
        html += `
            <div class="row mt-3">
                <div class="col-12">
                    <div class="card border-warning">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0"><i class="fas fa-link me-2"></i>Cross-Reference Analysis</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Patient ID Coverage</h6>
                                    <div class="progress mb-2">
                                        <div class="progress-bar" role="progressbar" 
                                             style="width: ${stats.cross_references.patient_coverage_percentage}%" 
                                             aria-valuenow="${stats.cross_references.patient_coverage_percentage}" 
                                             aria-valuemin="0" aria-valuemax="100">
                                            ${stats.cross_references.patient_coverage_percentage}%
                                        </div>
                                    </div>
                                    <small class="text-muted">
                                        ${stats.cross_references.patients_in_bracken} of ${stats.cross_references.total_patients} patients found in bracken results
                                    </small>
                                </div>
                                <div class="col-md-6">
                                    <h6>Taxonomy ID Coverage</h6>
                                    <div class="progress mb-2">
                                        <div class="progress-bar" role="progressbar" 
                                             style="width: ${stats.cross_references.taxonomy_coverage_percentage}%" 
                                             aria-valuenow="${stats.cross_references.taxonomy_coverage_percentage}" 
                                             aria-valuemin="0" aria-valuemax="100">
                                            ${stats.cross_references.taxonomy_coverage_percentage}%
                                        </div>
                                    </div>
                                    <small class="text-muted">
                                        ${stats.cross_references.taxonomies_in_bracken} of ${stats.cross_references.total_taxonomies} taxonomies found in bracken results
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Overall data quality summary
    if (stats.sanitization_needed && stats.sanitization_needed.length > 0) {
        html += `
            <div class="row mt-3">
                <div class="col-12">
                    <div class="alert alert-info">
                        <h6 class="mb-2"><i class="fas fa-info-circle me-2"></i>Data Quality Issues Detected</h6>
                        <ul class="mb-0">
                            ${stats.sanitization_needed.map(issue => `<li>${issue}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            </div>
        `;
    }
    
    statsSection.innerHTML = html;
}

window.getSanitizationButtons = function(fileType, fileStats, sanitizationNeeded) {
    if (!sanitizationNeeded || sanitizationNeeded.length === 0) {
        return '<div class="text-success"><i class="fas fa-check-circle me-2"></i>No sanitization needed</div>';
    }
    
    let buttons = '<div class="mt-3"><h6>Data Sanitization:</h6>';
    
    if (sanitizationNeeded.includes('remove_duplicates')) {
        buttons += `
            <button class="btn btn-warning btn-sm me-2 mb-2" 
                    onclick="sanitizeData('${fileType}', 'remove_duplicates')">
                <i class="fas fa-copy me-1"></i>Remove Duplicates
            </button>
        `;
    }
    
    if (sanitizationNeeded.includes('remove_missing_ids')) {
        buttons += `
            <button class="btn btn-info btn-sm me-2 mb-2" 
                    onclick="sanitizeData('${fileType}', 'remove_missing_ids')">
                <i class="fas fa-minus-circle me-1"></i>Remove Missing IDs
            </button>
        `;
    }
    
    if (sanitizationNeeded.includes('fill_missing_ids')) {
        buttons += `
            <button class="btn btn-primary btn-sm me-2 mb-2" 
                    onclick="sanitizeData('${fileType}', 'fill_missing_ids')">
                <i class="fas fa-plus-circle me-1"></i>Generate Missing IDs
            </button>
        `;
    }
    
    return buttons + '</div>';
}

window.showDataStatsError = function(error) {
    const statsSection = document.getElementById('dataStatsSection');
    statsSection.innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Error:</strong> ${error}
            <button class="btn btn-outline-danger btn-sm ms-3" onclick="loadDataStats()">
                <i class="fas fa-redo me-1"></i>Try Again
            </button>
        </div>
    `;
}

// Main initialization
document.addEventListener('DOMContentLoaded', function() {
    // Load metadata first, then initialize everything else
    loadAllMetadata().then(() => {
        // Initialize UI components with loaded metadata
        initializeColumnGroups();
        initializeTimePoints();
        
    // Load files and data stats on page load
    loadFiles();
    loadDataStats();
        
        // Load files for data sources dropdowns
        loadFilesForDataSources();
        
        // Load analysis list
        refreshAnalysisList();
    }).catch(error => {
        console.error('Error loading metadata:', error);
        // Fallback: initialize with empty metadata
        initializeColumnGroups();
        initializeTimePoints();
        loadFiles();
        loadDataStats();
        loadFilesForDataSources();
        refreshAnalysisList();
    });
    
    // Handle file uploads
    document.querySelectorAll('.upload-btn').forEach(btn => {
        btn.addEventListener('click', handleUpload);
    });
    
    // Handle file input changes
    document.querySelectorAll('input[type="file"]').forEach(input => {
        input.addEventListener('change', function() {
            // File selected - no additional handling needed
        });
    });
    
    function handleUpload(event) {
        const btn = event.target;
        const fileType = btn.dataset.fileType;
        const uploadSection = btn.closest('.upload-section');
        const fileInput = uploadSection.querySelector('input[type="file"]');
        
        // Disable button and show loading
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Uploading...';
        
        const formData = new FormData();
        formData.append('file_type', fileType);
        
        // Only handle file upload
        if (fileInput.files.length > 0) {
            formData.append('upload_method', 'file');
            formData.append('file', fileInput.files[0]);
        } else {
            showAlert('Please select a file to upload', 'warning');
            resetButton(btn);
            return;
        }
        
        // Send upload request
        fetch(`/dataset/${datasetId}/upload`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                
                // Show success message in the file type status box
                const statusElement = document.getElementById(`${fileType}-status`);
                if (statusElement) {
                    statusElement.className = 'alert alert-success border';
                    statusElement.innerHTML = `
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <strong>File uploaded successfully!</strong>
                        <div class="mt-1">${data.message}</div>
                    `;
                }
                
                updateUploadSection(uploadSection, fileType);
                console.log('Upload successful, dataset status:', data.dataset_status);
                updateProgress(data.dataset_status); // Update progress with response data
                
                // Refresh files immediately after successful upload
                loadFiles();
                
                // Also refresh data sources dropdowns
                loadFilesForDataSources();
            } else {
                showAlert(data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Upload error:', error);
            showAlert('Upload failed. Please try again.', 'danger');
        })
        .finally(() => {
            resetButton(btn);
        });
    }
    
    function startProcessingMonitor(fileType) {
        // Update the status alert box with processing message, keep upload form visible
        const statusElement = document.getElementById(`${fileType}-status`);
        if (statusElement) {
            statusElement.className = 'alert alert-info border';
            statusElement.innerHTML = `
                <i class="fas fa-cog fa-spin text-primary me-2"></i>
                <strong>Processing ${fileType} data...</strong>
                <div class="mt-2">Verifying, sanitizing, and validating your data</div>
                <div class="progress mt-2" style="height: 4px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" style="width: 100%"></div>
                </div>
            `;
        }
        
        // Start polling for processing status
        const pollInterval = setInterval(() => {
            fetch(`/dataset/${datasetId}/processing-status`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const fileStatus = data.processing_status[fileType];
                        if (fileStatus) {
                            if (fileStatus.status === 'completed') {
                                clearInterval(pollInterval);
                                showProcessingSuccess(null, fileType, fileStatus);
                            } else if (fileStatus.status === 'failed') {
                                clearInterval(pollInterval);
                                showProcessingError(null, fileType, fileStatus.error);
                            }
                            // If still processing, continue polling
                        }
                    }
                })
                .catch(error => {
                    console.error('Error checking processing status:', error);
                });
        }, 2000); // Poll every 2 seconds
        
        // Stop polling after 5 minutes (300 seconds)
        setTimeout(() => {
            clearInterval(pollInterval);
        }, 300000);
    }
    
    function showProcessingSuccess(uploadSection, fileType, fileStatus) {
        // Update the status alert box with success message, keep upload form visible
        const statusElement = document.getElementById(`${fileType}-status`);
        if (statusElement) {
            statusElement.className = 'alert alert-success border';
            let statusText = '<i class="fas fa-check-circle me-2"></i><strong>File processed successfully!</strong>';
            if (fileStatus.summary) {
                statusText += `<div class="mt-2 small">Rows: ${fileStatus.summary.total_rows}, Columns: ${fileStatus.summary.total_columns}`;
                if (fileStatus.summary.unique_patients) statusText += `, Patients: ${fileStatus.summary.unique_patients}`;
                if (fileStatus.summary.unique_taxonomies) statusText += `, Taxonomies: ${fileStatus.summary.unique_taxonomies}`;
                if (fileStatus.summary.unique_samples) statusText += `, Samples: ${fileStatus.summary.unique_samples}`;
                statusText += '</div>';
            }
            statusElement.innerHTML = statusText;
        }
        
        // Update progress and refresh files
        fetch(`/dataset/${datasetId}/files`)
            .then(response => response.json())
            .then(data => {
                updateProgress(data.dataset_status);
                updateFilesTable(data.files);
            });
    }
    
    function showProcessingError(uploadSection, fileType, error) {
        // Update the status alert box with error message, keep upload form visible
        const statusElement = document.getElementById(`${fileType}-status`);
        if (statusElement) {
            statusElement.className = 'alert alert-danger border';
            statusElement.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Processing failed:</strong> ${error}
            `;
        }
    }
    
    function updateUploadSection(uploadSection, fileType) {
        // Update the status alert box with upload success message
        const statusElement = document.getElementById(`${fileType}-status`);
        if (statusElement) {
            statusElement.className = 'alert alert-success border';
            statusElement.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                <strong>File uploaded successfully</strong>
            `;
        }
    }
    
    function loadFiles() {
        // Show loading state
        const filesTable = document.getElementById('filesTable');
        if (!filesTable) {
            console.error('Files table element not found');
            return;
        }
        
        filesTable.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                <p class="mt-2 text-muted">Updating files...</p>
            </div>
        `;
        
        fetch(`/dataset/${datasetId}/files`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Files data received:', data);
                updateFilesTable(data.files);
                updateProgress(data.dataset_status);
                
                // Also update the data sources dropdowns
                populateFileDropdowns(data.files);
            })
            .catch(error => {
                console.error('Error loading files:', error);
                if (filesTable) {
                    filesTable.innerHTML = `
                        <div class="text-center text-danger py-4">
                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                            <p class="mt-2">Error loading files</p>
                            <small class="text-muted">${error.message}</small>
                        </div>
                    `;
                }
            });
    }
    
    function updateFilesTable(files) {
        const filesTable = document.getElementById('filesTable');

        if (files.length === 0) {
            filesTable.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-folder-open fa-2x text-muted"></i>
                    <p class="mt-2 text-muted">No files uploaded yet</p>
                </div>
            `;
            return;
        }

        // Group files by type in the specified order: patients, bracken, taxonomy
        const groupedFiles = {
            patients: files.filter(file => file.file_type === 'patients'),
            bracken: files.filter(file => file.file_type === 'bracken'),
            taxonomy: files.filter(file => file.file_type === 'taxonomy')
        };

        const fileTypeOrder = ['patients', 'bracken', 'taxonomy'];
        const fileTypeLabels = {
            patients: 'Patients Data Files',
            bracken: 'Bracken Results Files',
            taxonomy: 'Taxonomy Data Files'
        };
        const fileTypeIcons = {
            patients: 'fas fa-users text-primary',
            bracken: 'fas fa-chart-bar text-success',
            taxonomy: 'fas fa-sitemap text-info'
        };

        let tableHTML = '';

        fileTypeOrder.forEach(fileType => {
            const typeFiles = groupedFiles[fileType];

            if (typeFiles.length > 0) {
                // Add separator/header for this file type
                tableHTML += `
                    <div class="file-group-separator" data-file-type="${fileType}">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <div class="d-flex align-items-center">
                                <i class="${fileTypeIcons[fileType]} me-2"></i>
                                <h6 class="mb-0 fw-bold">${fileTypeLabels[fileType]}</h6>
                            </div>
                            <span class="badge bg-secondary">${typeFiles.length} file${typeFiles.length > 1 ? 's' : ''}</span>
                        </div>
                        <hr class="my-2">
                    </div>
                    <div class="table-responsive mb-4">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Size</th>
                                    <th>Cure Status</th>
                                    <th>Uploaded</th>
                                    <th>Modified</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${typeFiles.map(file => `
                                    <tr>
                                        <td>
                                            <i class="fas fa-file-csv me-2 text-primary"></i>
                                            ${file.filename.replace(/\.csv$/i, '')}
                                        </td>
                                        <td>
                                            <span class="badge bg-${getFileTypeColor(file.file_type)}">
                                                ${file.file_type}
                                            </span>
                                        </td>
                                        <td>${formatFileSize(file.size)}</td>
                                        <td>${getCureStatusIcon(file.cure_status, file.cure_validation_status)}</td>
                                        <td>${new Date(file.uploaded_at).toLocaleDateString()}</td>
                                        <td>${new Date(file.modified_at).toLocaleDateString()}</td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-info me-1" onclick="renameFile(${file.id}, '${file.filename}', '${file.file_type}')" title="Rename File">
                                                <i class="fas fa-i-cursor"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-warning me-1" onclick="editTable('${file.id}')" title="Edit Table">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-success me-1" onclick="duplicateFile(${file.id})" title="Duplicate File">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-primary me-1" onclick="downloadFile(${file.id})">
                                                <i class="fas fa-download"></i>
                                            </button>
                                            <button class="btn btn-sm ${file.cure_status === 'cured' && file.cure_validation_status === 'ok' ? 'btn-success disabled' : 'btn-outline-secondary'}" 
                                                    onclick="cureData(${file.id})" 
                                                    ${file.cure_status === 'cured' && file.cure_validation_status === 'ok' ? 'disabled' : ''} 
                                                    title="Cure Data">
                                                <i class="fas fa-magic"></i> Cure
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteFile(${file.id})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
        });

        filesTable.innerHTML = tableHTML;
    }
    
    function updateProgress(datasetStatus) {
        if (datasetStatus) {
            // Update progress bar
            const progressBar = document.querySelector('.progress-bar');
            const progressBadge = document.querySelector('.badge');
            
            if (progressBar) {
                progressBar.style.width = datasetStatus.completion_percentage + '%';
                progressBar.className = `progress-bar bg-${datasetStatus.is_complete ? 'success' : 'warning'}`;
            }
            
            if (progressBadge) {
                progressBadge.className = `badge bg-${datasetStatus.is_complete ? 'success' : 'warning'}`;
                progressBadge.textContent = datasetStatus.completion_percentage + '% Complete';
            }
            
            // Update status indicators
            updateStatusIndicator('patients', datasetStatus.patients_uploaded);
            updateStatusIndicator('taxonomy', datasetStatus.taxonomy_uploaded);
            updateStatusIndicator('bracken', datasetStatus.bracken_uploaded);
            
            // Update statistics cards
            updateStatisticsCards(datasetStatus);
        }
    }
    
    function updateStatisticsCards(datasetStatus) {
        console.log('Updating statistics cards with:', datasetStatus);
        
        // Update file count card with animation
        const fileCountCard = document.querySelector('.card.border-primary .card-title');
        if (fileCountCard) {
            fileCountCard.style.transition = 'all 0.3s ease';
            fileCountCard.style.transform = 'scale(1.1)';
            fileCountCard.textContent = datasetStatus.file_count || 0;
            console.log('Updated file count to:', datasetStatus.file_count);
            setTimeout(() => {
                fileCountCard.style.transform = 'scale(1)';
            }, 300);
        }
        
        // Update total size card with animation
        const totalSizeCard = document.querySelector('.card.border-info .card-title');
        if (totalSizeCard && datasetStatus.total_size !== undefined) {
            totalSizeCard.style.transition = 'all 0.3s ease';
            totalSizeCard.style.transform = 'scale(1.1)';
            const sizeInMB = (datasetStatus.total_size / 1024 / 1024).toFixed(1);
            totalSizeCard.textContent = `${sizeInMB} MB`;
            console.log('Updated total size to:', sizeInMB, 'MB');
            setTimeout(() => {
                totalSizeCard.style.transform = 'scale(1)';
            }, 300);
        }
        
        // Update dataset status badge in header
        const statusBadge = document.querySelector('.badge.fs-6');
        if (statusBadge) {
            const statusClass = datasetStatus.is_complete ? 'success' : 
                              datasetStatus.status === 'processing' ? 'warning' : 
                              datasetStatus.status === 'error' ? 'danger' : 'secondary';
            statusBadge.className = `badge bg-${statusClass} fs-6`;
            statusBadge.textContent = datasetStatus.status ? datasetStatus.status.title() : 'Draft';
        }
    }
    
    function updateStatusIndicator(fileType, isUploaded) {
        const indicators = document.querySelectorAll(`[data-file-type="${fileType}"]`);
        indicators.forEach(indicator => {
            const icon = indicator.querySelector('i');
            const text = indicator.querySelector('span');
            
            // Check if elements exist before setting className
            if (icon) {
                if (isUploaded) {
                    icon.className = 'fas fa-check-circle text-success me-2';
                } else {
                    icon.className = 'fas fa-times-circle text-muted me-2';
                }
            }
            
            if (text) {
                if (isUploaded) {
                    text.className = 'text-success';
                } else {
                    text.className = 'text-muted';
                }
            }
        });
    }
    
    function getFileTypeColor(fileType) {
        const colors = {
            'patients': 'primary',
            'taxonomy': 'info',
            'bracken': 'success'
        };
        return colors[fileType] || 'secondary';
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    function getCureStatusIcon(cureStatus, validationStatus) {
        if (cureStatus === 'cured') {
            if (validationStatus === 'ok') {
                return '<i class="fas fa-check-circle text-success" title="Cured and validation OK"></i>';
            } else if (validationStatus === 'warnings') {
                return '<i class="fas fa-exclamation-triangle text-warning" title="Cured with warnings"></i>';
            } else if (validationStatus === 'errors') {
                return '<i class="fas fa-times-circle text-danger" title="Cured with errors"></i>';
            }
        } else if (cureStatus === 'curing') {
            return '<i class="fas fa-spinner fa-spin text-info" title="Curing in progress"></i>';
        } else if (cureStatus === 'failed') {
            return '<i class="fas fa-times-circle text-danger" title="Cure failed"></i>';
        } else {
            return '<i class="fas fa-clock text-muted" title="Not yet cured"></i>';
        }
    }
    
    function resetButton(btn) {
        const fileType = btn.dataset.fileType;
        btn.disabled = false;
        if (fileType) {
        btn.innerHTML = `<i class="fas fa-upload me-2"></i>Upload ${fileType.charAt(0).toUpperCase() + fileType.slice(1)} Data`;
        } else {
            btn.innerHTML = `<i class="fas fa-upload me-2"></i>Upload Data`;
        }
    }
    
    
         // Global functions for file actions
     window.downloadFile = function(fileId) {
         // TODO: Implement file download
         showAlert('Download functionality will be implemented soon', 'info');
     };
     
     // Global function for data sanitization
     window.sanitizeData = function(fileType, sanitizationType) {
         if (!confirm(`Are you sure you want to ${sanitizationType.replace(/_/g, ' ')} for ${fileType} data? This action cannot be undone.`)) {
             return;
         }
         
         // Show loading state
         const button = event.target;
         const originalText = button.innerHTML;
         button.disabled = true;
         button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Processing...';
         
         fetch(`/dataset/${datasetId}/sanitize`, {
             method: 'POST',
             headers: {
                 'Content-Type': 'application/json',
             },
             body: JSON.stringify({
                 type: sanitizationType,
                 file_type: fileType
             })
         })
         .then(response => response.json())
         .then(data => {
             if (data.success) {
                 showAlert(data.message, 'success');
                 
                 // Reload data stats to show updated information
                 setTimeout(() => {
                     loadDataStats();
                 }, 1000);
                 
                 // Reload files to show any updated file information
                 setTimeout(() => {
                     loadFiles();
                 }, 1500);
             } else {
                 showAlert(data.message, 'danger');
             }
         })
         .catch(error => {
             console.error('Sanitization error:', error);
             showAlert('Error during sanitization. Please try again.', 'danger');
         })
         .finally(() => {
             // Restore button state
             button.disabled = false;
             button.innerHTML = originalText;
         });
     };
     
     window.deleteFile = function(fileId) {
         // Show confirmation dialog with more details
         if (confirm('Are you sure you want to delete this file? This action cannot be undone and will remove the file from your dataset.')) {
             // Find the row to get file info for better user feedback
             const row = document.querySelector(`button[onclick="deleteFile(${fileId})"]`).closest('tr');
             const fileName = row.querySelector('td:first-child').textContent.trim();
             
             // Show loading state
             const deleteBtn = document.querySelector(`button[onclick="deleteFile(${fileId})"]`);
             const originalContent = deleteBtn.innerHTML;
             deleteBtn.disabled = true;
             deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
             
             // Send delete request
             fetch(`/dataset/${datasetId}/file/${fileId}/delete`, {
                 method: 'POST',
                 headers: {
                     'Content-Type': 'application/json',
                 }
             })
             .then(response => response.json())
             .then(data => {
                 if (data.success) {
                     showAlert(data.message, 'success');
                     
                     console.log('File deleted successfully, dataset status:', data.dataset_status);
                     
                     // Update progress and statistics
                     updateProgress(data.dataset_status);
                     
                     // Refresh the files table
                     loadFiles();
                    
                    // Also refresh data sources dropdowns
                    loadFilesForDataSources();
                     
                     // Check if we need to show upload sections again
                     console.log('Restoring upload sections...');
                     restoreUploadSections(data.dataset_status);
                 } else {
                     showAlert(data.message, 'danger');
                     // Restore button state on error
                     deleteBtn.disabled = false;
                     deleteBtn.innerHTML = originalContent;
                 }
             })
             .catch(error => {
                 console.error('Delete error:', error);
                 showAlert('Error deleting file. Please try again.', 'danger');
                 // Restore button state on error
                 deleteBtn.disabled = false;
                 deleteBtn.innerHTML = originalContent;
             });
         }
     };
     
     window.duplicateFile = function(fileId) {
         // Show confirmation dialog
         if (confirm('Are you sure you want to duplicate this file? A copy will be created with "_copy" appended to the filename.')) {
             // Find the row to get file info for better user feedback
             const row = document.querySelector(`button[onclick="duplicateFile(${fileId})"]`).closest('tr');
             const fileName = row.querySelector('td:first-child').textContent.trim();
             
             // Show loading state
             const duplicateBtn = document.querySelector(`button[onclick="duplicateFile(${fileId})"]`);
             const originalContent = duplicateBtn.innerHTML;
             duplicateBtn.disabled = true;
             duplicateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
             
             // Send duplicate request
             fetch(`/dataset/${datasetId}/file/${fileId}/duplicate`, {
                 method: 'POST',
                 headers: {
                     'Content-Type': 'application/json',
                 }
             })
             .then(response => response.json())
             .then(data => {
                 if (data.success) {
                     // Show success message in the specific file type status box
                     const statusElement = document.getElementById(`${data.file_type}-status`);
                     if (statusElement) {
                         statusElement.className = 'alert alert-success border';
                         statusElement.innerHTML = `
                             <i class="fas fa-check-circle text-success me-2"></i>
                             <strong>File duplicated successfully!</strong>
                             <div class="mt-1">${data.message}</div>
                         `;
                     }
                     
                     console.log('File duplicated successfully, dataset status:', data.dataset_status);
                     
                     // Update progress and statistics
                     updateProgress(data.dataset_status);
                     
                     // Refresh the files table
                     loadFiles();
                    
                    // Also refresh data sources dropdowns
                    loadFilesForDataSources();
                     
                     // Check if we need to show upload sections again
                     console.log('Restoring upload sections...');
                     restoreUploadSections(data.dataset_status);
                 } else {
                     showAlert(data.message, 'danger');
                     // Restore button state on error
                     duplicateBtn.disabled = false;
                     duplicateBtn.innerHTML = originalContent;
                 }
             })
             .catch(error => {
                 console.error('Duplicate error:', error);
                 showAlert('Error duplicating file. Please try again.', 'danger');
                 // Restore button state on error
                 duplicateBtn.disabled = false;
                 duplicateBtn.innerHTML = originalContent;
             });
         }
     };
     
     window.renameFile = function(fileId, currentName, fileType) {
         // Extract the base name without extension for better UX
         const lastDotIndex = currentName.lastIndexOf('.');
         const baseName = lastDotIndex !== -1 ? currentName.substring(0, lastDotIndex) : currentName;
         const extension = lastDotIndex !== -1 ? currentName.substring(lastDotIndex) : '';
         
         // Prompt user for new name
         const newBaseName = prompt('Enter new file name:', baseName);
         
         if (newBaseName === null || newBaseName.trim() === '') {
             return; // User cancelled or entered empty name
         }
         
         if (newBaseName === baseName) {
             showAlert('File name unchanged', 'info');
             return;
         }
         
         const newName = extension ? newBaseName.trim() + extension : newBaseName.trim();
         
         // Show loading state
         const renameBtn = document.querySelector(`button[onclick="renameFile(${fileId}, '${currentName}', '${fileType}')"]`);
         const originalContent = renameBtn.innerHTML;
         renameBtn.disabled = true;
         renameBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
         
         // Send rename request
         fetch(`/dataset/${datasetId}/file/${fileId}/rename`, {
             method: 'POST',
             headers: {
                 'Content-Type': 'application/json',
             },
             body: JSON.stringify({
                 new_filename: newName
             })
         })
         .then(response => response.json())
         .then(data => {
             console.log('Rename response:', data); // Debug log
             if (data.success) {
                 console.log('Rename successful, updating UI...'); // Debug log
                 showAlert(data.message, 'success');
                 
                 // Update the status alert box with rename message
                 const statusElement = document.getElementById(`${data.file_type}-status`);
                 if (statusElement) {
                     statusElement.className = 'alert alert-info border';
                     statusElement.innerHTML = `
                         <i class="fas fa-edit me-2"></i>
                         <strong>${data.file_type} file "${data.old_filename}" renamed to "${data.new_filename}"</strong>
                     `;
                 }
                 
                 // Update the filename in the table row immediately
                 const fileRow = document.querySelector(`button[onclick*="${fileId}"]`);
                 console.log('Found file row:', fileRow); // Debug log
                 if (fileRow) {
                     const row = fileRow.closest('tr');
                     if (row) {
                         const nameCell = row.querySelector('td:first-child');
                         console.log('Found name cell:', nameCell); // Debug log
                         if (nameCell) {
                             // Update the filename display (remove .csv extension for display)
                             const displayName = data.new_filename.replace(/\.csv$/i, '');
                             nameCell.innerHTML = `<i class="fas fa-file-csv me-2 text-primary"></i>${displayName}`;
                             console.log('Updated name cell to:', displayName); // Debug log
                         }
                         
                         // Update the button's onclick attribute with new filename
                         const buttons = row.querySelectorAll('button[onclick*="renameFile"]');
                         buttons.forEach(btn => {
                             btn.setAttribute('onclick', `renameFile(${fileId}, '${data.new_filename}', '${fileType}')`);
                             console.log('Updated button onclick to:', `renameFile(${fileId}, '${data.new_filename}', '${fileType}')`); // Debug log
                         });
                     }
                 }
                 
                 // Refresh the files table to ensure consistency
                 setTimeout(() => loadFiles(), 500); // Delay slightly to show immediate update
             } else {
                 showAlert(data.message, 'danger');
                 // Restore button state on error
                 renameBtn.disabled = false;
                 renameBtn.innerHTML = originalContent;
             }
         })
         .catch(error => {
             console.error('Rename error:', error);
             showAlert('Error renaming file. Please try again.', 'danger');
             // Restore button state on error
             renameBtn.disabled = false;
             renameBtn.innerHTML = originalContent;
         });
     };     window.editTable = function(file_id) {
         // Navigate to the edit table page
         window.location.href = `/file/${file_id}`;
     };
     
     // Delete Dataset Functions - Make them globally accessible
     window.showDeleteConfirmation = function() {
         const modal = new bootstrap.Modal(document.getElementById('deleteDatasetModal'));
         modal.show();
     };
     
     window.checkDeleteConfirmation = function() {
         const input = document.getElementById('deleteConfirmation');
         const confirmBtn = document.getElementById('confirmDeleteBtn');
         
         if (input.value.toLowerCase() === 'delete') {
             confirmBtn.disabled = false;
             confirmBtn.classList.remove('btn-danger');
             confirmBtn.classList.add('btn-danger');
         } else {
             confirmBtn.disabled = true;
         }
     };
     
     window.deleteDataset = function() {
         const confirmBtn = document.getElementById('confirmDeleteBtn');
         const input = document.getElementById('deleteConfirmation');
         
         // Double-check confirmation
         if (input.value.toLowerCase() !== 'delete') {
             showAlert('Please type "delete" to confirm deletion', 'warning');
             return;
         }
         
         // Disable button and show loading
         confirmBtn.disabled = true;
         confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Deleting...';
         
         // Send delete request
         fetch(`/dataset/${datasetId}/delete`, {
             method: 'POST',
             headers: {
                 'Content-Type': 'application/json',
             }
         })
         .then(response => response.json())
         .then(data => {
             if (data.success) {
                 showAlert(data.message, 'success');
                 
                 // Close modal
                 const modal = bootstrap.Modal.getInstance(document.getElementById('deleteDatasetModal'));
                 modal.hide();
                 
                 // Redirect to dashboard after a short delay
                 setTimeout(() => {
                     window.location.href = data.redirect_url;
                 }, 1500);
             } else {
                 showAlert(data.message, 'danger');
                 resetDeleteButton();
             }
         })
         .catch(error => {
             console.error('Delete error:', error);
             showAlert('Error deleting dataset. Please try again.', 'danger');
             resetDeleteButton();
         });
     };
     
     function resetDeleteButton() {
         const confirmBtn = document.getElementById('confirmDeleteBtn');
         confirmBtn.disabled = false;
         confirmBtn.innerHTML = '<i class="fas fa-trash me-1"></i>Delete Dataset';
     }
     
     function restoreUploadSections(datasetStatus) {
         // Restore upload sections for files that are no longer uploaded
         const fileTypes = ['patients', 'taxonomy', 'bracken'];
         const uploadedFlags = {
             'patients': datasetStatus.patients_uploaded,
             'taxonomy': datasetStatus.taxonomy_uploaded,
             'bracken': datasetStatus.bracken_uploaded
         };
         
         fileTypes.forEach(fileType => {
             if (!uploadedFlags[fileType]) {
                 // Use the specific ID to find the correct card body
                 const cardBodyId = `${fileType}-upload-body`;
                 const cardBody = document.getElementById(cardBodyId);
                 
                 if (cardBody) {
                     // Restore the upload interface
                     const capitalizedType = fileType.charAt(0).toUpperCase() + fileType.slice(1);
                     const colors = {'patients': 'primary', 'taxonomy': 'info', 'bracken': 'success'};
                     const color = colors[fileType];
                     
                     cardBody.innerHTML = `
                         <div class="upload-section" data-file-type="${fileType}">
                             <!-- File Upload -->
                             <div class="mb-3">
                                 <label class="form-label">Upload File</label>
                                 <input type="file" class="form-control" accept=".csv,.tsv,.txt" 
                                        name="file" data-file-type="${fileType}" data-upload-method="file">
                                 <div class="form-text">Supported formats: CSV, TSV, TXT</div>
                             </div>
                             
                             <button type="button" class="btn btn-${color} w-100 upload-btn" 
                                     data-file-type="${fileType}">
                                 <i class="fas fa-upload me-2"></i>
                                 Upload ${capitalizedType} Data
                             </button>
                             
                             <!-- Status/Results Box -->
                             <div class="mt-3" id="${fileType}-status-container">
                                 <div class="alert alert-light border" role="alert" id="${fileType}-status" style="padding: 0.75rem 1rem;">
                                     <i class="fas fa-info-circle text-muted me-2"></i>
                                     <span class="text-muted">No actions yet</span>
                                 </div>
                             </div>
                         </div>
                     `;
                     
                     // Re-attach event listeners for the new elements
                     const newUploadBtn = cardBody.querySelector('.upload-btn');
                     const newFileInput = cardBody.querySelector('input[type="file"]');
                     
                     if (newUploadBtn) {
                         newUploadBtn.addEventListener('click', handleUpload);
                     }
                     
                     if (newFileInput) {
                         newFileInput.addEventListener('change', function() {
                             // File input change handling if needed
                         });
                     }
                     
                     console.log(`Restored upload section for ${fileType} to correct location`);
                 } else {
                     console.error(`Could not find card body with ID: ${cardBodyId}`);
                 }
             }
         });
     }
});

window.cureData = function(fileId) {
    // Show confirmation dialog
    if (!confirm('Are you sure you want to cure this data? This will process and validate the file.')) {
        return;
    }
    
    // Find the button and show loading state
    const cureBtn = document.querySelector(`button[onclick="cureData(${fileId})"]`);
    const originalContent = cureBtn.innerHTML;
    cureBtn.disabled = true;
    cureBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Curing...';
    
    // Send cure request
    fetch(`/dataset/${datasetId}/file/${fileId}/cure`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            
            // Update the status alert box
            const statusElement = document.getElementById(`${data.file_type}-status`);
            if (statusElement) {
                statusElement.className = 'alert alert-success border';
                statusElement.innerHTML = `
                    <i class="fas fa-magic me-2"></i>
                    <strong>Data cured successfully!</strong>
                    <div class="mt-1">${data.message}</div>
                `;
            }
            
            // Refresh the files table to show updated cure status
            loadFiles();
        } else {
            showAlert(data.message, 'danger');
            // Restore button state on error
            cureBtn.disabled = false;
            cureBtn.innerHTML = originalContent;
        }
    })
    .catch(error => {
        console.error('Cure error:', error);
        showAlert('Error curing data. Please try again.', 'danger');
        // Restore button state on error
        cureBtn.disabled = false;
        cureBtn.innerHTML = originalContent;
    });
};

// Tab Navigation Functions
window.goToTab = function(tabId) {
    const tabButton = document.getElementById(tabId);
    if (tabButton) {
        const tab = new bootstrap.Tab(tabButton);
        tab.show();
    }
};

// Clear report filters function
window.clearReportFilters = function() {
    document.getElementById('reportSearch').value = '';
    document.getElementById('reportTypeFilter').value = 'all';
    document.getElementById('reportStatusFilter').value = 'all';
    // Trigger filter update if implemented
    // filterReports();
};

// Data Sources Tab Functions (removed - no longer needed after restructuring)

// Dynamic metadata loading
let COLUMN_GROUPS = {};
let TIME_POINTS = {};
let TIME_POINTS_ORDERED = []; // Store ordered time points
let ANALYSIS_METHODS = {};
let CLUSTERING_METHODS = {};

// Load metadata dynamically from backend
window.loadMetadata = function(metadataType) {
    return fetch(`/metadata/${metadataType}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                return data;
            } else {
                console.error(`Error loading ${metadataType}:`, data.message);
                return { success: false, data: {} };
            }
        })
        .catch(error => {
            console.error(`Error loading ${metadataType}:`, error);
            return { success: false, data: {} };
        });
};

// Load all metadata
window.loadAllMetadata = function() {
    return Promise.all([
        loadMetadata('column_groups').then(response => { 
            COLUMN_GROUPS = response.data; 
            // Transform the data to include UI metadata
            Object.keys(COLUMN_GROUPS).forEach(key => {
                if (Array.isArray(COLUMN_GROUPS[key])) {
                    COLUMN_GROUPS[key] = {
                        'name': key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                        'icon': getColumnGroupIcon(key),
                        'description': getColumnGroupDescription(key),
                        'count': COLUMN_GROUPS[key].length,
                        'columns': COLUMN_GROUPS[key]
                    };
                }
            });
        }),
        loadMetadata('time_points').then(response => { 
            if (response.is_ordered) {
                // Store both ordered list and object
                TIME_POINTS_ORDERED = response.data;
                TIME_POINTS = {};
                response.data.forEach(item => {
                    TIME_POINTS[item.key] = item.value;
                });
            } else {
                TIME_POINTS = response;
                TIME_POINTS_ORDERED = Object.entries(response).map(([key, value]) => ({key, value}));
            }
        }),
        loadMetadata('analysis_methods').then(response => { 
            ANALYSIS_METHODS = response.data; 
        }),
        loadMetadata('clustering_methods').then(response => { 
            CLUSTERING_METHODS = response.data; 
        })
    ]);
};

// Helper functions to generate UI metadata for column groups
function getColumnGroupIcon(groupKey) {
    const iconMap = {
        'demographics': 'fas fa-users text-primary',
        'disease_characteristics': 'fas fa-stethoscope text-danger',
        'fish_indicators': 'fas fa-dna text-warning',
        'treatment_and_transplantation': 'fas fa-procedures text-success',
        'laboratory_values': 'fas fa-vial text-info',
        'genomic_markers': 'fas fa-microscope text-purple',
        'antiviral': 'fas fa-pills text-success',
        'antibiotics': 'fas fa-capsules text-primary',
        'antifungal': 'fas fa-leaf text-success',
        'comorbidities': 'fas fa-heartbeat text-danger'
    };
    return iconMap[groupKey] || 'fas fa-list text-secondary';
}

function getColumnGroupDescription(groupKey) {
    const descMap = {
        'demographics': 'Age, gender, race, ethnicity, BMI, smoking status',
        'disease_characteristics': 'IgG/IgA, mutations, staging, biomarkers',
        'fish_indicators': 'Chromosomal abnormalities and translocations',
        'treatment_and_transplantation': 'Therapy, transplant dates, survival outcomes',
        'laboratory_values': 'Blood counts, biomarkers, clinical labs',
        'genomic_markers': 'Mutations, deletions, rearrangements',
        'antiviral': 'Acyclovir, valacyclovir',
        'antibiotics': 'Various antibiotic treatments',
        'antifungal': 'Fluconazole treatments',
        'comorbidities': 'Engraftment syndrome indicators'
    };
    return descMap[groupKey] || 'Data group for analysis';
}

// Initialize column groups interface
window.initializeColumnGroups = function() {
    const container = document.getElementById('columnGroupsContainer');
    if (!container) return;
    
    // Check if metadata is loaded
    if (Object.keys(COLUMN_GROUPS).length === 0) {
        container.innerHTML = '<div class="col-12"><div class="alert alert-info">Loading column groups...</div></div>';
        return;
    }
    
    let html = '';
    Object.keys(COLUMN_GROUPS).forEach(groupKey => {
        const group = COLUMN_GROUPS[groupKey];
        html += `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="form-check border rounded p-3 h-100">
                    <input class="form-check-input" type="checkbox" value="${groupKey}" id="group_${groupKey}" name="group_${groupKey}" onchange="updateColumnGroupSelection()">
                    <label class="form-check-label w-100" for="group_${groupKey}">
                        <div class="d-flex align-items-center mb-2">
                            <i class="${group.icon} me-2"></i>
                            <strong>${group.name}</strong>
                        </div>
                        <div class="small text-muted">
                            ${group.description}
                            <div class="mt-1">
                                <span class="badge bg-light text-dark">${group.count} columns</span>
                            </div>
                        </div>
                    </label>
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
};

window.updateColumnGroupSelection = function() {
    const checkboxes = document.querySelectorAll('#columnGroupsContainer input[type="checkbox"]');
    const selectedGroups = [];
    let totalColumns = 0;
    
    checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
            selectedGroups.push(checkbox.value);
            totalColumns += COLUMN_GROUPS[checkbox.value].count;
        }
    });
    
    const summaryElement = document.getElementById('selectionSummary');
    const countElement = document.getElementById('totalColumnsCount');
    
    if (selectedGroups.length === 0) {
        summaryElement.textContent = 'No column groups selected';
        countElement.textContent = '0 total columns';
    } else {
        summaryElement.textContent = `${selectedGroups.length} group${selectedGroups.length > 1 ? 's' : ''} selected: ${selectedGroups.map(g => COLUMN_GROUPS[g].name).join(', ')}`;
        countElement.textContent = `${totalColumns} total columns`;
    }
};

window.selectAllColumnGroups = function() {
    const checkboxes = document.querySelectorAll('#columnGroupsContainer input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
    updateColumnGroupSelection();
};

window.clearAllColumnGroups = function() {
    const checkboxes = document.querySelectorAll('#columnGroupsContainer input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    updateColumnGroupSelection();
};

// Initialize time points dropdown
window.initializeTimePoints = function() {
    const select = document.getElementById('editorBrackenTimePointSelect');
    if (!select) return;
    
    // Check if metadata is loaded
    if (Object.keys(TIME_POINTS).length === 0) {
        select.innerHTML = '<option value="">Loading time points...</option>';
        return;
    }
    
    // Clear existing options except the first one
    while (select.children.length > 1) {
        select.removeChild(select.lastChild);
    }
    
    // Add options from metadata in the order they appear in the file
    // Use the ordered list to guarantee order preservation
    TIME_POINTS_ORDERED.forEach(item => {
        const option = document.createElement('option');
        option.value = item.key;
        option.textContent = `${item.value.description} (${item.value.suffix})`;
        select.appendChild(option);
    });
};

// All time point description logic is now handled by window.analysisManager in dataset_analysis.js

// Global alert function
window.showAlert = function(message, type) {
    // Create alert element
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert at the top of the content
    const container = document.querySelector('.container');
    if (container) {
        container.insertBefore(alertDiv, container.firstChild);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
};

// Analysis Management Functions
window.currentEditingAnalysisId = null;

window.createNewAnalysis = function() {
    currentEditingAnalysisId = null;
    document.getElementById('editorTitle').textContent = 'New Analysis';
    document.getElementById('analysisName').value = '';
    document.getElementById('analysisDescription').value = '';
    
    // Reset all form fields to defaults
    resetAnalysisEditor();
    
    // Show the editor section
    document.getElementById('analysisEditorSection').style.display = 'block';
    
    // Populate file dropdowns in editor
    loadFilesForDataSources();
    initializeColumnGroups();
    initializeTimePoints();
    
    // Make sure to populate editor dropdowns specifically
    setTimeout(() => {
        fetch(`/dataset/${datasetId}/files`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    populateFileDropdowns(data.files);
                }
            })
            .catch(error => console.error('Error loading files for editor:', error));
    }, 100);
    
    // Scroll to editor
    document.getElementById('analysisEditorSection').scrollIntoView({ behavior: 'smooth' });
};

window.editAnalysis = function(analysisId) {
    currentEditingAnalysisId = analysisId;
    document.getElementById('editorTitle').textContent = 'Edit Analysis';
    
    // Load analysis data
    fetch(`/dataset/${datasetId}/analysis/${analysisId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                populateAnalysisEditor(data.analysis);
                document.getElementById('analysisEditorSection').style.display = 'block';
                document.getElementById('analysisEditorSection').scrollIntoView({ behavior: 'smooth' });
            } else {
                showAlert(data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error loading analysis:', error);
            showAlert('Error loading analysis details', 'danger');
        });
};

window.duplicateAnalysis = function(analysisId) {
    if (!confirm('Create a copy of this analysis?')) return;
    
    fetch(`/dataset/${datasetId}/analysis/${analysisId}/duplicate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            refreshAnalysisList();
        } else {
            showAlert(data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error duplicating analysis:', error);
        showAlert('Error duplicating analysis', 'danger');
    });
};

window.deleteAnalysis = function(analysisId) {
    if (!confirm('Are you sure you want to delete this analysis? This action cannot be undone.')) return;
    
    fetch(`/dataset/${datasetId}/analysis/${analysisId}/delete`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            refreshAnalysisList();
        } else {
            showAlert(data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error deleting analysis:', error);
        showAlert('Error deleting analysis', 'danger');
    });
};

window.runAnalysis = function(analysisId) {
    if (!confirm('Run this analysis? This may take several minutes.')) return;
    
    fetch(`/dataset/${datasetId}/analysis/${analysisId}/run`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            refreshAnalysisList();
            
            // Optionally redirect to results page
            if (data.results_url) {
                setTimeout(() => {
                    window.location.href = data.results_url;
                }, 2000);
            }
        } else {
            showAlert(data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error running analysis:', error);
        showAlert('Error running analysis', 'danger');
    });
};

window.runAnalysisFromEditor = function() {
    if (!validateAnalysisEditor()) {
        showAlert('Please fill in all required fields before running analysis', 'warning');
        return;
    }
    
    // Save first, then run
    saveAnalysis(true); // true = run after save
};

window.saveAnalysis = function(runAfterSave = false) {
    if (!validateAnalysisEditor()) {
        showAlert('Please fill in all required fields', 'warning');
        return;
    }
    
    const analysisData = collectAnalysisData();
    const isEdit = currentEditingAnalysisId !== null;
    const url = isEdit ? 
        `/dataset/${datasetId}/analysis/${currentEditingAnalysisId}` : 
        `/dataset/${datasetId}/analysis`;
    const method = isEdit ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(analysisData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            refreshAnalysisList();
            
            if (runAfterSave) {
                // Run the analysis
                const analysisId = data.analysis_id || currentEditingAnalysisId;
                setTimeout(() => runAnalysis(analysisId), 1000);
            } else {
                cancelAnalysisEdit();
            }
        } else {
            showAlert(data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error saving analysis:', error);
        showAlert('Error saving analysis', 'danger');
    });
};

window.cancelAnalysisEdit = function() {
    document.getElementById('analysisEditorSection').style.display = 'none';
    currentEditingAnalysisId = null;
};

window.refreshAnalysisList = function() {
    // For now, just show empty state since backend endpoint doesn't exist yet
    // This prevents the 404 error from appearing in console
    populateAnalysisList([]);
    
    // TODO: Uncomment when backend endpoint is implemented
    /*
    fetch(`/dataset/${datasetId}/analyses`)
        .then(response => {
            if (response.status === 404) {
                // Endpoint not implemented yet, show empty state
                populateAnalysisList([]);
                return;
            }
            return response.json();
        })
        .then(data => {
            if (data && data.success) {
                populateAnalysisList(data.analyses);
            } else if (data) {
                showAlert(data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error loading analyses:', error);
            // Show empty state on error instead of alert
            populateAnalysisList([]);
        });
    */
};

window.populateAnalysisList = function(analyses) {
    const noAnalysesState = document.getElementById('noAnalysesState');
    const analysisTable = document.getElementById('analysisTable');
    const tableBody = document.getElementById('analysisTableBody');
    
    if (analyses.length === 0) {
        noAnalysesState.style.display = 'block';
        analysisTable.style.display = 'none';
    } else {
        noAnalysesState.style.display = 'none';
        analysisTable.style.display = 'block';
        
        tableBody.innerHTML = analyses.map(analysis => `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <i class="fas fa-chart-line text-primary me-2"></i>
                        <div>
                            <div class="fw-bold">${analysis.name}</div>
                            ${analysis.description ? `<small class="text-muted">${analysis.description}</small>` : ''}
                        </div>
                    </div>
                </td>
                <td>${new Date(analysis.created_at).toLocaleDateString()}</td>
                <td>${new Date(analysis.modified_at).toLocaleDateString()}</td>
                <td>${formatFileSize(analysis.size || 0)}</td>
                <td>${analysis.last_run ? new Date(analysis.last_run).toLocaleDateString() : 'Never'}</td>
                <td>${analysis.patient_count || 0}</td>
                <td>
                    <span class="badge bg-${getAnalysisStatusColor(analysis.status)}">${analysis.status}</span>
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="editAnalysis(${analysis.id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-success" onclick="duplicateAnalysis(${analysis.id})" title="Duplicate">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteAnalysis(${analysis.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="btn btn-primary" onclick="runAnalysis(${analysis.id})" title="Run Analysis">
                            <i class="fas fa-play"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }
};

// Helper functions
window.resetAnalysisEditor = function() {
    // Reset all form fields
    document.querySelectorAll('#analysisEditorSection input, #analysisEditorSection select').forEach(element => {
        if (element.type === 'checkbox' || element.type === 'radio') {
            element.checked = element.defaultChecked;
        } else {
            element.value = element.defaultValue || '';
        }
    });
    
    // Reset to first tab
    const firstTab = document.querySelector('#analysisEditorTabs .nav-link');
    if (firstTab) {
        const tab = new bootstrap.Tab(firstTab);
        tab.show();
    }
};

window.validateAnalysisEditor = function() {
    const name = document.getElementById('analysisName').value.trim();
    const patientFile = document.getElementById('editorPatientFileSelect').value;
    const taxonomyFile = document.getElementById('editorTaxonomyFileSelect').value;
    const brackenFile = document.getElementById('editorBrackenFileSelect').value;
    const timePoint = document.getElementById('editorBrackenTimePointSelect').value;
    
    return name && patientFile && taxonomyFile && brackenFile && timePoint;
};

window.collectAnalysisData = function() {
    // Collect all form data
    const selectedColumnGroups = [];
    document.querySelectorAll('#columnGroupsContainer input[type="checkbox"]:checked').forEach(cb => {
        selectedColumnGroups.push(cb.value);
    });
    
    return {
        name: document.getElementById('analysisName').value.trim(),
        description: document.getElementById('analysisDescription').value.trim(),
        patient_file_id: document.getElementById('editorPatientFileSelect').value,
        taxonomy_file_id: document.getElementById('editorTaxonomyFileSelect').value,
        bracken_file_id: document.getElementById('editorBrackenFileSelect').value,
        time_point: document.getElementById('editorBrackenTimePointSelect').value,
        column_groups: selectedColumnGroups,
        analysis_type: document.querySelector('input[name="editorAnalysisType"]:checked').value,
        taxonomic_level: document.getElementById('editorTaxonomicLevel').value,
        min_abundance: parseFloat(document.getElementById('editorMinAbundance').value),
        statistical_method: document.getElementById('editorStatisticalMethod').value,
        p_value_correction: document.getElementById('editorPValueCorrection').value,
        report_formats: {
            pdf: document.getElementById('reportPDF').checked,
            html: document.getElementById('reportHTML').checked,
            csv: document.getElementById('reportCSV').checked
        },
        report_content: {
            summary: document.getElementById('includeSummary').checked,
            plots: document.getElementById('includePlots').checked,
            raw_data: document.getElementById('includeRawData').checked
        }
    };
};

window.populateAnalysisEditor = function(analysis) {
    document.getElementById('analysisName').value = analysis.name || '';
    document.getElementById('analysisDescription').value = analysis.description || '';
    
    // Set file selections
    if (analysis.patient_file_id) document.getElementById('editorPatientFileSelect').value = analysis.patient_file_id;
    if (analysis.taxonomy_file_id) document.getElementById('editorTaxonomyFileSelect').value = analysis.taxonomy_file_id;
    if (analysis.bracken_file_id) document.getElementById('editorBrackenFileSelect').value = analysis.bracken_file_id;
    if (analysis.time_point) document.getElementById('editorBrackenTimePointSelect').value = analysis.time_point;
    
    // Set column groups
    if (analysis.column_groups) {
        document.querySelectorAll('#columnGroupsContainer input[type="checkbox"]').forEach(cb => {
            cb.checked = analysis.column_groups.includes(cb.value);
        });
        updateColumnGroupSelection();
    }
    
    // Set analysis configuration
    if (analysis.analysis_type) {
        const radio = document.querySelector(`input[name="editorAnalysisType"][value="${analysis.analysis_type}"]`);
        if (radio) radio.checked = true;
    }
    
    if (analysis.taxonomic_level) document.getElementById('editorTaxonomicLevel').value = analysis.taxonomic_level;
    if (analysis.min_abundance) document.getElementById('editorMinAbundance').value = analysis.min_abundance;
    if (analysis.statistical_method) document.getElementById('editorStatisticalMethod').value = analysis.statistical_method;
    if (analysis.p_value_correction) document.getElementById('editorPValueCorrection').value = analysis.p_value_correction;
    
    // Set report configuration
    if (analysis.report_formats) {
        document.getElementById('reportPDF').checked = analysis.report_formats.pdf || false;
        document.getElementById('reportHTML').checked = analysis.report_formats.html || false;
        document.getElementById('reportCSV').checked = analysis.report_formats.csv || false;
    }
    
    if (analysis.report_content) {
        document.getElementById('includeSummary').checked = analysis.report_content.summary || false;
        document.getElementById('includePlots').checked = analysis.report_content.plots || false;
        document.getElementById('includeRawData').checked = analysis.report_content.raw_data || false;
    }
};

window.getAnalysisStatusColor = function(status) {
    const colors = {
        'draft': 'secondary',
        'ready': 'primary',
        'running': 'warning',
        'completed': 'success',
        'failed': 'danger'
    };
    return colors[status] || 'secondary';
};

// Load files for data sources dropdowns
window.loadFilesForDataSources = function() {
    fetch(`/dataset/${datasetId}/files`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Files data for dropdowns:', data);
            populateFileDropdowns(data.files);
        })
        .catch(error => {
            console.error('Error loading files for data sources:', error);
            // Show empty state in dropdowns
            populateFileDropdowns([]);
        });
};

// Populate the file selection dropdowns
window.populateFileDropdowns = function(files) {
    // Group files by type
    const filesByType = {
        patients: files.filter(file => file.file_type === 'patients'),
        taxonomy: files.filter(file => file.file_type === 'taxonomy'),
        bracken: files.filter(file => file.file_type === 'bracken')
    };
    
    // Populate editor dropdowns
    populateDropdown('editorPatientFileSelect', filesByType.patients, 'patient');
    populateDropdown('editorTaxonomyFileSelect', filesByType.taxonomy, 'taxonomy');
    populateDropdown('editorBrackenFileSelect', filesByType.bracken, 'bracken');
};

// Helper function to populate individual dropdown
window.populateDropdown = function(selectId, files, fileType) {
    const select = document.getElementById(selectId);
    if (!select) {
        // Don't show error for missing editor dropdowns when they're not visible
        if (selectId.startsWith('editor') && document.getElementById('analysisEditorSection').style.display === 'none') {
            return;
        }
        console.warn(`Dropdown ${selectId} not found`);
        return;
    }
    
    // Clear existing options except the first one
    while (select.children.length > 1) {
        select.removeChild(select.lastChild);
    }
    
    if (files.length === 0) {
        // Add a disabled option indicating no files
        const noFilesOption = document.createElement('option');
        noFilesOption.value = '';
        noFilesOption.textContent = `No ${fileType} files uploaded`;
        noFilesOption.disabled = true;
        select.appendChild(noFilesOption);
        
        // Update the default option text
        select.children[0].textContent = `No ${fileType} files available`;
    } else {
        // Reset the default option text
        select.children[0].textContent = `Select ${fileType} file...`;
        
        // Add file options
        files.forEach(file => {
            const option = document.createElement('option');
            option.value = file.id;
            option.textContent = file.filename;
            
            // Add additional info as data attributes
            option.dataset.fileSize = file.size;
            option.dataset.fileType = file.file_type;
            option.dataset.cureStatus = file.cure_status;
            
            // Add visual indicator for cure status
            let statusIndicator = '';
            if (file.cure_status === 'cured' && file.cure_validation_status === 'ok') {
                statusIndicator = ' ';
            } else if (file.cure_status === 'cured' && file.cure_validation_status === 'warnings') {
                statusIndicator = ' ';
            } else if (file.cure_status === 'failed') {
                statusIndicator = ' ';
            } else if (file.cure_status === 'curing') {
                statusIndicator = ' ';
            }
            
            option.textContent = file.filename + statusIndicator;
            select.appendChild(option);
        });
        
        // Auto-select if only one file available
        if (files.length === 1) {
            select.value = files[0].id;
        }
    }
};

// Add dashed border CSS class for the quick start guide
const style = document.createElement('style');
style.textContent = `
    .border-dashed {
        border: 2px dashed #dee2e6 !important;
        border-radius: 0.375rem;
    }
    .border-dashed:hover {
        border-color: #adb5bd !important;
        background-color: #f8f9fa;
    }
`;
document.head.appendChild(style);

</script>

<style>
.file-group-separator {
    background: linear-gradient(90deg, #f8f9fa 0%, #e9ecef 50%, #f8f9fa 100%);
    border-radius: 8px;
    padding: 0.75rem 1rem;
    margin: 1.5rem 0 0.5rem 0;
    border-left: 4px solid #007bff;
}

.file-group-separator h6 {
    color: #495057;
    font-weight: 600;
    margin-bottom: 0;
}

.file-group-separator .badge {
    font-size: 0.75rem;
    padding: 0.375rem 0.75rem;
    font-weight: 500;
    border-radius: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    background: linear-gradient(135deg, #6c757d, #5a6268) !important;
    color: white;
    border: none;
}

.file-group-separator hr {
    border: none;
    height: 2px;
    background: linear-gradient(90deg, #007bff, #28a745, #17a2b8);
    margin: 0.5rem 0;
    border-radius: 1px;
}

/* Different colors for different file types */
.file-group-separator[data-file-type="patients"] {
    border-left-color: #007bff;
}

.file-group-separator[data-file-type="bracken"] {
    border-left-color: #28a745;
}

.file-group-separator[data-file-type="taxonomy"] {
    border-left-color: #17a2b8;
}
</style>

{% endblock %}

