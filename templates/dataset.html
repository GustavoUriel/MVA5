{% extends "base.html" %}

{% block title %}{{ dataset.name }} - Microbiome Analysis Platform{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Header -->
    <div class="mb-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="{{ url_for('dashboard') }}">
                        <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item active">{{ dataset.name }}</li>
            </ol>
        </nav>
        
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <h1 class="h2 mb-2">
                    <i class="fas fa-folder-open me-2 text-primary"></i>
                    {{ dataset.name }}
                </h1>
                <div class="d-flex align-items-center gap-3">
                    <span class="badge bg-{{ 'success' if dataset.status == 'ready' else 'secondary' if dataset.status == 'draft' else 'warning' if dataset.status == 'processing' else 'danger' }} fs-6">
                        {{ dataset.status.title() }}
                    </span>
                    <small class="text-muted">
                        <i class="fas fa-calendar-alt me-1"></i>
                        Created {{ dataset.created_at.strftime('%B %d, %Y') }}
                    </small>
                    <small class="text-muted">
                        <i class="fas fa-edit me-1"></i>
                        Updated {{ dataset.updated_at.strftime('%B %d, %Y') }}
                    </small>
                </div>
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-primary">
                    <i class="fas fa-upload me-1"></i>
                    Upload Files
                </button>
                <button type="button" class="btn btn-outline-success">
                    <i class="fas fa-play me-1"></i>
                    Run Analysis
                </button>
                <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fas fa-cog"></i>
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#"><i class="fas fa-edit me-2"></i>Edit Dataset</a></li>
                    <li><a class="dropdown-item" href="#"><i class="fas fa-download me-2"></i>Export Data</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="#" onclick="showDeleteConfirmation()">
                        <i class="fas fa-trash me-2"></i>Delete Dataset
                    </a></li>
                </ul>
            </div>
        </div>
        
        {% if dataset.description %}
            <p class="text-muted mt-2">{{ dataset.description }}</p>
        {% endif %}
    </div>

    <!-- Overview Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-primary">
                <div class="card-body text-center">
                    <i class="fas fa-file fa-2x text-primary mb-2"></i>
                    <h5 class="card-title">{{ dataset.file_count }}</h5>
                    <p class="card-text text-muted mb-0">Files</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-info">
                <div class="card-body text-center">
                    <i class="fas fa-hdd fa-2x text-info mb-2"></i>
                    <h5 class="card-title">
                        {% if dataset.total_size %}
                            {{ "%.1f"|format(dataset.total_size / 1024 / 1024) }} MB
                        {% else %}
                            0 MB
                        {% endif %}
                    </h5>
                    <p class="card-text text-muted mb-0">Total Size</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-success">
                <div class="card-body text-center">
                    <i class="fas fa-chart-line fa-2x text-success mb-2"></i>
                    <h5 class="card-title">0</h5>
                    <p class="card-text text-muted mb-0">Analyses</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-warning">
                <div class="card-body text-center">
                    <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                    <h5 class="card-title">
                        {{ ((dataset.updated_at - dataset.created_at).days) }}d
                    </h5>
                    <p class="card-text text-muted mb-0">Age</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Tabs -->
    <div class="card">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" id="datasetTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="files-tab" data-bs-toggle="tab" data-bs-target="#files" type="button" role="tab">
                        <i class="fas fa-folder me-2"></i>Files
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="analysis-tab" data-bs-toggle="tab" data-bs-target="#analysis" type="button" role="tab">
                        <i class="fas fa-chart-line me-2"></i>Analysis
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
                        <i class="fas fa-cog me-2"></i>Settings
                    </button>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content" id="datasetTabsContent">
                <!-- Files Tab -->
                <div class="tab-pane fade show active" id="files" role="tabpanel">
                    <!-- Upload Progress -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <h6 class="mb-0">Dataset Completion</h6>
                            <span class="badge bg-{{ 'success' if dataset.is_complete else 'warning' }}">
                                {{ dataset.completion_percentage }}% Complete
                            </span>
                        </div>
                        <div class="progress mb-3">
                            <div class="progress-bar bg-{{ 'success' if dataset.is_complete else 'warning' }}" 
                                 role="progressbar" 
                                 style="width: {{ dataset.completion_percentage }}%">
                            </div>
                        </div>
                        <div class="row text-center">
                            <div class="col-md-4">
                                <div class="d-flex align-items-center justify-content-center">
                                    <i class="fas fa-{{ 'check-circle text-success' if dataset.patients_file_uploaded else 'times-circle text-muted' }} me-2"></i>
                                    <span class="{{ 'text-success' if dataset.patients_file_uploaded else 'text-muted' }}">
                                        Patients Data
                                    </span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-center justify-content-center">
                                    <i class="fas fa-{{ 'check-circle text-success' if dataset.taxonomy_file_uploaded else 'times-circle text-muted' }} me-2"></i>
                                    <span class="{{ 'text-success' if dataset.taxonomy_file_uploaded else 'text-muted' }}">
                                        Taxonomy Data
                                    </span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-center justify-content-center">
                                    <i class="fas fa-{{ 'check-circle text-success' if dataset.bracken_file_uploaded else 'times-circle text-muted' }} me-2"></i>
                                    <span class="{{ 'text-success' if dataset.bracken_file_uploaded else 'text-muted' }}">
                                        Bracken Results
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Upload Interface -->
                    <div class="row mb-4">
                        <!-- Patients Data Upload -->
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-user-injured me-2 text-primary"></i>
                                        Patients Data
                                    </h6>
                                </div>
                                <div class="card-body">
                                    {% if dataset.patients_file_uploaded %}
                                        <div class="text-center text-success mb-3">
                                            <i class="fas fa-check-circle fa-2x"></i>
                                            <p class="mt-2 mb-0">File uploaded successfully</p>
                                        </div>
                                    {% else %}
                                        <div class="upload-section" data-file-type="patients">
                                            <!-- File Upload -->
                                            <div class="mb-3">
                                                <label class="form-label">Upload File</label>
                                                <input type="file" class="form-control" accept=".csv,.tsv,.txt" 
                                                       data-file-type="patients" data-upload-method="file">
                                                <div class="form-text">Supported formats: CSV, TSV, TXT</div>
                                            </div>
                                            
                                            <div class="text-center mb-3">
                                                <span class="text-muted">or</span>
                                            </div>
                                            
                                            <!-- CSV Paste -->
                                            <div class="mb-3">
                                                <label class="form-label">Paste CSV Data</label>
                                                <textarea class="form-control" rows="6" placeholder="Paste your CSV data here..."
                                                          data-file-type="patients" data-upload-method="csv_paste"></textarea>
                                                <div class="form-text">Paste comma-separated values directly</div>
                                            </div>
                                            
                                            <button type="button" class="btn btn-primary w-100 upload-btn" 
                                                    data-file-type="patients">
                                                <i class="fas fa-upload me-2"></i>
                                                Upload Patients Data
                                            </button>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Taxonomy Data Upload -->
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-sitemap me-2 text-info"></i>
                                        Taxonomy Data
                                    </h6>
                                </div>
                                <div class="card-body">
                                    {% if dataset.taxonomy_file_uploaded %}
                                        <div class="text-center text-success mb-3">
                                            <i class="fas fa-check-circle fa-2x"></i>
                                            <p class="mt-2 mb-0">File uploaded successfully</p>
                                        </div>
                                    {% else %}
                                        <div class="upload-section" data-file-type="taxonomy">
                                            <!-- File Upload -->
                                            <div class="mb-3">
                                                <label class="form-label">Upload File</label>
                                                <input type="file" class="form-control" accept=".csv,.tsv,.txt" 
                                                       data-file-type="taxonomy" data-upload-method="file">
                                                <div class="form-text">Supported formats: CSV, TSV, TXT</div>
                                            </div>
                                            
                                            <div class="text-center mb-3">
                                                <span class="text-muted">or</span>
                                            </div>
                                            
                                            <!-- CSV Paste -->
                                            <div class="mb-3">
                                                <label class="form-label">Paste CSV Data</label>
                                                <textarea class="form-control" rows="6" placeholder="Paste your CSV data here..."
                                                          data-file-type="taxonomy" data-upload-method="csv_paste"></textarea>
                                                <div class="form-text">Paste comma-separated values directly</div>
                                            </div>
                                            
                                            <button type="button" class="btn btn-info w-100 upload-btn" 
                                                    data-file-type="taxonomy">
                                                <i class="fas fa-upload me-2"></i>
                                                Upload Taxonomy Data
                                            </button>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Bracken Results Upload -->
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-chart-bar me-2 text-success"></i>
                                        Bracken Results
                                    </h6>
                                </div>
                                <div class="card-body">
                                    {% if dataset.bracken_file_uploaded %}
                                        <div class="text-center text-success mb-3">
                                            <i class="fas fa-check-circle fa-2x"></i>
                                            <p class="mt-2 mb-0">File uploaded successfully</p>
                                        </div>
                                    {% else %}
                                        <div class="upload-section" data-file-type="bracken">
                                            <!-- File Upload -->
                                            <div class="mb-3">
                                                <label class="form-label">Upload File</label>
                                                <input type="file" class="form-control" accept=".csv,.tsv,.txt" 
                                                       data-file-type="bracken" data-upload-method="file">
                                                <div class="form-text">Supported formats: CSV, TSV, TXT</div>
                                            </div>
                                            
                                            <div class="text-center mb-3">
                                                <span class="text-muted">or</span>
                                            </div>
                                            
                                            <!-- CSV Paste -->
                                            <div class="mb-3">
                                                <label class="form-label">Paste CSV Data</label>
                                                <textarea class="form-control" rows="6" placeholder="Paste your CSV data here..."
                                                          data-file-type="bracken" data-upload-method="csv_paste"></textarea>
                                                <div class="form-text">Paste comma-separated values directly</div>
                                            </div>
                                            
                                            <button type="button" class="btn btn-success w-100 upload-btn" 
                                                    data-file-type="bracken">
                                                <i class="fas fa-upload me-2"></i>
                                                Upload Bracken Results
                                            </button>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Uploaded Files Table -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-folder me-2"></i>
                                Uploaded Files
                            </h6>
                        </div>
                        <div class="card-body">
                            <div id="filesTable">
                                <div class="text-center py-4">
                                    <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                                    <p class="mt-2 text-muted">Loading files...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analysis Tab -->
                <div class="tab-pane fade" id="analysis" role="tabpanel">
                    <div class="text-center py-5">
                        <i class="fas fa-flask fa-4x text-muted mb-3"></i>
                        <h5 class="text-muted mb-3">Analysis Tools Coming Soon</h5>
                        <p class="text-muted mb-4">
                            Advanced statistical analysis tools will be available here.
                        </p>
                        <button type="button" class="btn btn-outline-primary" disabled>
                            <i class="fas fa-play me-2"></i>
                            Run Analysis
                        </button>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div class="tab-pane fade" id="settings" role="tabpanel">
                    <form>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="datasetName" class="form-label">Dataset Name</label>
                                    <input type="text" class="form-control" id="datasetName" value="{{ dataset.name }}">
                                </div>
                                <div class="mb-3">
                                    <label for="datasetDescription" class="form-label">Description</label>
                                    <textarea class="form-control" id="datasetDescription" rows="4">{{ dataset.description or '' }}</textarea>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Dataset Status</label>
                                    <select class="form-select">
                                        <option value="draft" {{ 'selected' if dataset.status == 'draft' else '' }}>Draft</option>
                                        <option value="ready" {{ 'selected' if dataset.status == 'ready' else '' }}>Ready</option>
                                        <option value="processing" {{ 'selected' if dataset.status == 'processing' else '' }}>Processing</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Privacy Settings</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="privacy" id="private" checked>
                                        <label class="form-check-label" for="private">
                                            <i class="fas fa-lock me-1"></i>Private (only you)
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="privacy" id="shared" disabled>
                                        <label class="form-check-label text-muted" for="shared">
                                            <i class="fas fa-users me-1"></i>Shared (coming soon)
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="border-top pt-3">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-save me-1"></i>Save Changes
                            </button>
                            <button type="button" class="btn btn-outline-secondary">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Dataset Confirmation Modal -->
<div class="modal fade" id="deleteDatasetModal" tabindex="-1" aria-labelledby="deleteDatasetModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteDatasetModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Delete Dataset
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <h6 class="alert-heading">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Warning: This action cannot be undone!
                    </h6>
                    <p class="mb-2">You are about to delete the dataset <strong>"{{ dataset.name }}"</strong> and all its associated data:</p>
                    <ul class="mb-3">
                        <li><strong>{{ dataset.file_count }}</strong> uploaded files</li>
                        <li><strong>{{ "%.1f"|format(dataset.total_size / 1024 / 1024) if dataset.total_size else 0 }} MB</strong> of data</li>
                        <li>All analysis results and metadata</li>
                    </ul>
                    <p class="mb-0"><strong>This action is permanent and cannot be reversed.</strong></p>
                </div>
                
                <div class="mb-3">
                    <label for="deleteConfirmation" class="form-label">
                        To confirm deletion, please type <code>delete</code> in the box below:
                    </label>
                    <input type="text" class="form-control" id="deleteConfirmation" 
                           placeholder="Type 'delete' to confirm" 
                           oninput="checkDeleteConfirmation()">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" disabled onclick="deleteDataset()">
                    <i class="fas fa-trash me-1"></i>Delete Dataset
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const datasetId = {{ dataset.id }};
    
    // Load files on page load
    loadFiles();
    
    // Handle file uploads
    document.querySelectorAll('.upload-btn').forEach(btn => {
        btn.addEventListener('click', handleUpload);
    });
    
    // Handle file input changes
    document.querySelectorAll('input[type="file"]').forEach(input => {
        input.addEventListener('change', function() {
            const fileType = this.dataset.fileType;
            const uploadSection = this.closest('.upload-section');
            const textarea = uploadSection.querySelector('textarea');
            textarea.value = ''; // Clear textarea when file is selected
        });
    });
    
    // Handle textarea changes
    document.querySelectorAll('textarea').forEach(textarea => {
        textarea.addEventListener('input', function() {
            const fileType = this.dataset.fileType;
            const uploadSection = this.closest('.upload-section');
            const fileInput = uploadSection.querySelector('input[type="file"]');
            fileInput.value = ''; // Clear file input when textarea is used
        });
    });
    
    function handleUpload(event) {
        const btn = event.target;
        const fileType = btn.dataset.fileType;
        const uploadSection = btn.closest('.upload-section');
        const fileInput = uploadSection.querySelector('input[type="file"]');
        const textarea = uploadSection.querySelector('textarea');
        
        // Disable button and show loading
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Uploading...';
        
        const formData = new FormData();
        formData.append('file_type', fileType);
        
        // Determine upload method
        if (fileInput.files.length > 0) {
            formData.append('upload_method', 'file');
            formData.append('file', fileInput.files[0]);
        } else if (textarea.value.trim()) {
            formData.append('upload_method', 'csv_paste');
            formData.append('csv_content', textarea.value.trim());
        } else {
            showAlert('Please select a file or paste CSV data', 'warning');
            resetButton(btn);
            return;
        }
        
        // Send upload request
        fetch(`/dataset/${datasetId}/upload`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                updateUploadSection(uploadSection, fileType);
                console.log('Upload successful, dataset status:', data.dataset_status);
                updateProgress(data.dataset_status); // Update progress with response data
                
                // Add a small delay to ensure database is updated
                setTimeout(() => {
                    loadFiles(); // Refresh files table
                }, 500);
            } else {
                showAlert(data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Upload error:', error);
            showAlert('Upload failed. Please try again.', 'danger');
        })
        .finally(() => {
            resetButton(btn);
        });
    }
    
    function updateUploadSection(uploadSection, fileType) {
        uploadSection.innerHTML = `
            <div class="text-center text-success mb-3">
                <i class="fas fa-check-circle fa-2x"></i>
                <p class="mt-2 mb-0">File uploaded successfully</p>
            </div>
        `;
    }
    
    function loadFiles() {
        // Show loading state
        const filesTable = document.getElementById('filesTable');
        filesTable.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                <p class="mt-2 text-muted">Updating files...</p>
            </div>
        `;
        
        fetch(`/dataset/${datasetId}/files`)
            .then(response => response.json())
            .then(data => {
                updateFilesTable(data.files);
                updateProgress(data.dataset_status);
            })
            .catch(error => {
                console.error('Error loading files:', error);
                document.getElementById('filesTable').innerHTML = `
                    <div class="text-center text-danger py-4">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                        <p class="mt-2">Error loading files</p>
                    </div>
                `;
            });
    }
    
    function updateFilesTable(files) {
        const filesTable = document.getElementById('filesTable');
        
        if (files.length === 0) {
            filesTable.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-folder-open fa-2x text-muted"></i>
                    <p class="mt-2 text-muted">No files uploaded yet</p>
                </div>
            `;
            return;
        }
        
        const tableHTML = `
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Size</th>
                            <th>Upload Method</th>
                            <th>Uploaded</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${files.map(file => `
                            <tr>
                                <td>
                                    <i class="fas fa-file-csv me-2 text-primary"></i>
                                    ${file.filename}
                                </td>
                                <td>
                                    <span class="badge bg-${getFileTypeColor(file.file_type)}">
                                        ${file.file_type}
                                    </span>
                                </td>
                                <td>${formatFileSize(file.size)}</td>
                                <td>
                                    <span class="badge bg-${file.upload_method === 'file' ? 'primary' : 'info'}">
                                        ${file.upload_method === 'file' ? 'File Upload' : 'CSV Paste'}
                                    </span>
                                </td>
                                <td>${new Date(file.uploaded_at).toLocaleDateString()}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="downloadFile(${file.id})">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteFile(${file.id})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        
        filesTable.innerHTML = tableHTML;
    }
    
    function updateProgress(datasetStatus) {
        if (datasetStatus) {
            // Update progress bar
            const progressBar = document.querySelector('.progress-bar');
            const progressBadge = document.querySelector('.badge');
            
            progressBar.style.width = datasetStatus.completion_percentage + '%';
            progressBar.className = `progress-bar bg-${datasetStatus.is_complete ? 'success' : 'warning'}`;
            progressBadge.className = `badge bg-${datasetStatus.is_complete ? 'success' : 'warning'}`;
            progressBadge.textContent = datasetStatus.completion_percentage + '% Complete';
            
            // Update status indicators
            updateStatusIndicator('patients', datasetStatus.patients_uploaded);
            updateStatusIndicator('taxonomy', datasetStatus.taxonomy_uploaded);
            updateStatusIndicator('bracken', datasetStatus.bracken_uploaded);
            
            // Update statistics cards
            updateStatisticsCards(datasetStatus);
        }
    }
    
    function updateStatisticsCards(datasetStatus) {
        console.log('Updating statistics cards with:', datasetStatus);
        
        // Update file count card with animation
        const fileCountCard = document.querySelector('.card.border-primary .card-title');
        if (fileCountCard) {
            fileCountCard.style.transition = 'all 0.3s ease';
            fileCountCard.style.transform = 'scale(1.1)';
            fileCountCard.textContent = datasetStatus.file_count || 0;
            console.log('Updated file count to:', datasetStatus.file_count);
            setTimeout(() => {
                fileCountCard.style.transform = 'scale(1)';
            }, 300);
        }
        
        // Update total size card with animation
        const totalSizeCard = document.querySelector('.card.border-info .card-title');
        if (totalSizeCard && datasetStatus.total_size !== undefined) {
            totalSizeCard.style.transition = 'all 0.3s ease';
            totalSizeCard.style.transform = 'scale(1.1)';
            const sizeInMB = (datasetStatus.total_size / 1024 / 1024).toFixed(1);
            totalSizeCard.textContent = `${sizeInMB} MB`;
            console.log('Updated total size to:', sizeInMB, 'MB');
            setTimeout(() => {
                totalSizeCard.style.transform = 'scale(1)';
            }, 300);
        }
        
        // Update dataset status badge in header
        const statusBadge = document.querySelector('.badge.fs-6');
        if (statusBadge) {
            const statusClass = datasetStatus.is_complete ? 'success' : 
                              datasetStatus.status === 'processing' ? 'warning' : 
                              datasetStatus.status === 'error' ? 'danger' : 'secondary';
            statusBadge.className = `badge bg-${statusClass} fs-6`;
            statusBadge.textContent = datasetStatus.status ? datasetStatus.status.title() : 'Draft';
        }
    }
    
    function updateStatusIndicator(fileType, isUploaded) {
        const indicators = document.querySelectorAll(`[data-file-type="${fileType}"]`);
        indicators.forEach(indicator => {
            const icon = indicator.querySelector('i');
            const text = indicator.querySelector('span');
            
            if (isUploaded) {
                icon.className = 'fas fa-check-circle text-success me-2';
                text.className = 'text-success';
            } else {
                icon.className = 'fas fa-times-circle text-muted me-2';
                text.className = 'text-muted';
            }
        });
    }
    
    function getFileTypeColor(fileType) {
        const colors = {
            'patients': 'primary',
            'taxonomy': 'info',
            'bracken': 'success'
        };
        return colors[fileType] || 'secondary';
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    function resetButton(btn) {
        const fileType = btn.dataset.fileType;
        btn.disabled = false;
        btn.innerHTML = `<i class="fas fa-upload me-2"></i>Upload ${fileType.charAt(0).toUpperCase() + fileType.slice(1)} Data`;
    }
    
    function showAlert(message, type) {
        // Create alert element
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Insert at the top of the content
        const container = document.querySelector('.container');
        container.insertBefore(alertDiv, container.firstChild);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
    
         // Global functions for file actions
     window.downloadFile = function(fileId) {
         // TODO: Implement file download
         showAlert('Download functionality will be implemented soon', 'info');
     };
     
     window.deleteFile = function(fileId) {
         if (confirm('Are you sure you want to delete this file?')) {
             // TODO: Implement file deletion
             showAlert('Delete functionality will be implemented soon', 'info');
         }
     };
     
     // Delete Dataset Functions - Make them globally accessible
     window.showDeleteConfirmation = function() {
         const modal = new bootstrap.Modal(document.getElementById('deleteDatasetModal'));
         modal.show();
     };
     
     window.checkDeleteConfirmation = function() {
         const input = document.getElementById('deleteConfirmation');
         const confirmBtn = document.getElementById('confirmDeleteBtn');
         
         if (input.value.toLowerCase() === 'delete') {
             confirmBtn.disabled = false;
             confirmBtn.classList.remove('btn-danger');
             confirmBtn.classList.add('btn-danger');
         } else {
             confirmBtn.disabled = true;
         }
     };
     
     window.deleteDataset = function() {
         const confirmBtn = document.getElementById('confirmDeleteBtn');
         const input = document.getElementById('deleteConfirmation');
         
         // Double-check confirmation
         if (input.value.toLowerCase() !== 'delete') {
             showAlert('Please type "delete" to confirm deletion', 'warning');
             return;
         }
         
         // Disable button and show loading
         confirmBtn.disabled = true;
         confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Deleting...';
         
         // Send delete request
         fetch(`/dataset/${datasetId}/delete`, {
             method: 'POST',
             headers: {
                 'Content-Type': 'application/json',
             }
         })
         .then(response => response.json())
         .then(data => {
             if (data.success) {
                 showAlert(data.message, 'success');
                 
                 // Close modal
                 const modal = bootstrap.Modal.getInstance(document.getElementById('deleteDatasetModal'));
                 modal.hide();
                 
                 // Redirect to dashboard after a short delay
                 setTimeout(() => {
                     window.location.href = data.redirect_url;
                 }, 1500);
             } else {
                 showAlert(data.message, 'danger');
                 resetDeleteButton();
             }
         })
         .catch(error => {
             console.error('Delete error:', error);
             showAlert('Error deleting dataset. Please try again.', 'danger');
             resetDeleteButton();
         });
     };
     
     function resetDeleteButton() {
         const confirmBtn = document.getElementById('confirmDeleteBtn');
         confirmBtn.disabled = false;
         confirmBtn.innerHTML = '<i class="fas fa-trash me-1"></i>Delete Dataset';
     }
 });
</script>
{% endblock %}
