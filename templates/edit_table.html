{% extends "base.html" %}

{% block title %}Edit {{ table_type.title() }} Table - {{ dataset.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-2">
                        <i class="fas fa-edit text-warning me-2"></i>
                        Edit {{ table_type.title() }} Table
                    </h1>
                    <p class="text-muted mb-0">
                        Dataset: <strong>{{ dataset.name }}</strong> â€¢ 
                        Table: <span class="badge bg-warning">{{ table_type.title() }}</span>
                    </p>
                </div>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('view_dataset', dataset_id=dataset.id) }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to Dataset
                    </a>
                    <button class="btn btn-success" onclick="saveTable()">
                        <i class="fas fa-save me-1"></i>Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Table Container -->
    <div class="row">
        <div class="col-12">
            <div id="table-editor-container">
                <!-- Smart table will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Instructions -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="alert alert-info">
                <h5><i class="fas fa-info-circle me-2"></i>Table Editing Instructions</h5>
                <ul class="mb-0">
                    <li><strong>Enable Edit Mode:</strong> Click the "Enable Edit" button to start editing</li>
                    <li><strong>Edit Cells:</strong> Double-click on any editable cell to modify its content</li>
                    <li><strong>Filter Data:</strong> Use the column headers to filter and sort your data</li>
                    <li><strong>Save Changes:</strong> Click "Save Changes" to save your modifications</li>
                    <li><strong>Export:</strong> Use the "Download CSV" button to export filtered data</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5>Loading {{ table_type.title() }} Table...</h5>
                <p class="text-muted mb-0">Please wait while we prepare your data for editing.</p>
            </div>
        </div>
    </div>
</div>

<!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Error Loading Table
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="errorMessage">An error occurred while loading the table.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="retryLoadTable()">Retry</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/smart-table.js') }}"></script>
<script>
// Global variables
let tableComponent = null;
let datasetId = {{ dataset.id }};
let tableType = '{{ table_type }}';
let apiBase = `/api/dataset/${datasetId}/table/${tableType}`;

// Show loading modal
function showLoading() {
    const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
    modal.show();
}

// Hide loading modal
function hideLoading() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('loadingModal'));
    if (modal) {
        modal.hide();
    }
}

// Show error modal
function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    const modal = new bootstrap.Modal(document.getElementById('errorModal'));
    modal.show();
}

// Retry loading table
function retryLoadTable() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('errorModal'));
    if (modal) {
        modal.hide();
    }
    loadTable();
}

// Load the table
async function loadTable() {
    try {
        showLoading();
        
        // Create the smart table component
        tableComponent = await createTableComponent('#table-editor-container', apiBase, {
            showDebug: true, // Set to true for debugging
            pageSize: 25,
            filename: `${tableType}_${datasetId}_export`,
            storageKey: `table_${datasetId}_${tableType}`,
            columnConfig: {
                // Custom column configurations can be added here
                // Example:
                // 'status': {
                //     displayType: 'label',
                //     colorScheme: 'custom',
                //     customColors: {
                //         'active': '#28a745',
                //         'inactive': '#dc3545'
                //     }
                // }
            }
        });
        
        if (tableComponent) {
            console.log('Table loaded successfully:', tableComponent);
            hideLoading();
        } else {
            throw new Error('Failed to create table component');
        }
        
    } catch (error) {
        console.error('Error loading table:', error);
        hideLoading();
        showError(`Failed to load table: ${error.message}`);
    }
}

// Save table changes
async function saveTable() {
    if (!tableComponent) {
        showError('Table not loaded. Please refresh the page and try again.');
        return;
    }
    
    try {
        // Get modified data from the table component
        const modifiedData = tableComponent.getModifiedData();
        
        if (!modifiedData.hasChanges) {
            // No changes to save
            showNotification('No changes to save', 'info');
            return;
        }
        
        // Show loading state
        const saveBtn = document.querySelector('button[onclick="saveTable()"]');
        const originalText = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';
        
        // Save to server
        const response = await fetch(apiBase + '/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(modifiedData)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.status === 'success') {
            showNotification(`Successfully saved ${result.total_records} records!`, 'success');
            
            // Reset save button
            saveBtn.innerHTML = '<i class="fas fa-check me-1"></i>Saved!';
            saveBtn.className = 'btn btn-success';
            
            setTimeout(() => {
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;
                saveBtn.className = 'btn btn-success';
            }, 2000);
            
        } else {
            throw new Error(result.message || 'Unknown error occurred');
        }
        
    } catch (error) {
        console.error('Error saving table:', error);
        showError(`Failed to save changes: ${error.message}`);
        
        // Reset save button
        const saveBtn = document.querySelector('button[onclick="saveTable()"]');
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
    }
}

// Show notification
function showNotification(message, type = 'info') {
    // Create toast notification
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    // Add to container or create one
    let toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        document.body.appendChild(toastContainer);
    }
    
    toastContainer.appendChild(toast);
    
    // Show toast
    if (typeof bootstrap !== 'undefined' && bootstrap.Toast) {
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        // Remove from DOM after hiding
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
    } else {
        // Fallback: show as alert and auto-hide
        toast.style.display = 'block';
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadTable();
});

// Handle page unload to warn about unsaved changes
window.addEventListener('beforeunload', function(e) {
    if (tableComponent && tableComponent.getModifiedData && tableComponent.getModifiedData().hasChanges) {
        e.preventDefault();
        e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
        return 'You have unsaved changes. Are you sure you want to leave?';
    }
});
</script>
{% endblock %}
