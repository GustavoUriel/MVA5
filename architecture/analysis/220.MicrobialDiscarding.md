# 220.MicrobialDiscarding.md: Microbial Count Selection/Discard Methods

This document presents **microbial count selection and discard methods** to reduce dimensionality after attribute grouping, removing noise while preserving biologically relevant microbial signals.

---

## üéØ Phase 2 Overview

**Goal:** Reduce the selected microbial counts (potentially hundreds) to the most informative microbial abundance measurements (10-50) for downstream analysis.

**Why After Attribute Grouping:** Start with biologically relevant attributes, then refine based on microbial abundance quality and statistical properties.

---

## üìä Microbial Count Selection/Discard Methods

### **1. Prevalence Filtering - Remove Rare Microbial Counts**
**Description:** Discard microbial abundance measurements present in fewer than a specified percentage of samples, removing unreliable microbial count data.

**Algorithm:**
```
For each microbial abundance measurement:
    prevalence = (count > detection_threshold).sum() / total_samples
    if prevalence < min_prevalence_threshold:
        discard_microbial_count
```

**Parameters:**
- Detection threshold (default: >0 counts)
- Minimum prevalence (default: 10% of samples)

**Pros:**
- ‚úÖ **Data quality control** - Eliminates measurement artifacts and rare microbial counts
- ‚úÖ **Statistical reliability** - Focuses on consistently detectable microbial abundances
- ‚úÖ **Computational efficiency** - Reduces dataset size significantly
- ‚úÖ **Reproducibility** - Removes microbial counts with unreliable abundance estimates
- ‚úÖ **Simple implementation** - Easy to understand and apply

**Cons:**
- ‚ùå **May discard important microbes** - Some biologically relevant microbes may have low counts
- ‚ùå **Arbitrary thresholds** - Prevalence cutoff is subjective
- ‚ùå **Context dependence** - Optimal prevalence varies by study design and technology
- ‚ùå **False negatives** - Rare pathogens or keystone species may be excluded

**Limitations:**
- Doesn't consider abundance levels, only presence/counts
- May be too conservative for some research questions
- Threshold selection requires biological knowledge

**Why Choose:** Essential first step for data quality control in microbiome abundance studies.

**Expected Results:** Reduces microbial count measurements by 20-60%, depending on threshold

---

### **2. Abundance Filtering - Remove Low-Abundance Microbial Counts**
**Description:** Discard microbial measurements with consistently low abundance counts across samples, focusing on ecologically important microbes.

**Algorithm:**
```
For each microbial abundance measurement:
    mean_count = microbial_counts.mean()
    median_count = microbial_counts.median()
    max_count = microbial_counts.max()

    if mean_count < min_mean_threshold or median_count < min_median_threshold:
        discard_microbial_count
```

**Parameters:**
- Minimum mean abundance count (default: 1-10 counts depending on sequencing depth)
- Minimum median abundance count (default: 0.5-5 counts)
- Optional maximum abundance filtering

**Pros:**
- ‚úÖ **Ecological relevance** - Focuses on microbes that contribute meaningfully to community counts
- ‚úÖ **Measurement precision** - Removes microbial counts near detection limits
- ‚úÖ **Biological signal** - Prioritizes microbes with functional impact based on abundance
- ‚úÖ **Data normalization** - Complements count transformations and normalizations
- ‚úÖ **Statistical power** - Reduces noise in downstream analyses

**Cons:**
- ‚ùå **Context dependence** - Abundance thresholds vary by sample type and sequencing technology
- ‚ùå **Functional bias** - May exclude important low-abundance functional specialists
- ‚ùå **Normalization effects** - Results depend on count transformation method
- ‚ùå **Sample variability** - Count distributions vary across studies

**Limitations:**
- Requires appropriate count normalization (rarefaction, CSS, TMM, etc.)
- May miss conditionally abundant taxa (bloomers under specific conditions)
- Thresholds need validation against biological knowledge

**Why Choose:** Complements prevalence filtering by focusing on ecologically significant microbial abundances.

**Expected Results:** Further reduces microbial count measurements by 10-40%, depending on thresholds

---

### **3. Variance-Based Selection - Keep Most Variable Microbial Counts**
**Description:** Select microbial abundance measurements with highest variance across samples, identifying microbes that differ between patients or conditions.

**Algorithm:**
```
For each microbial abundance measurement:
    variance = microbial_counts.var()
    coefficient_of_variation = variance / mean_count

    rank_microbial_counts_by_variance()
    select_top_n_most_variable()
```

**Parameters:**
- Number of microbial counts to select (default: 50)
- Variance metric (total variance, coefficient of variation)
- Optional weighting by mean abundance

**Pros:**
- ‚úÖ **Biological heterogeneity** - Identifies microbes that vary between individuals based on counts
- ‚úÖ **Condition differences** - Captures microbes that change abundance with disease states
- ‚úÖ **Data-driven** - No biological assumptions required
- ‚úÖ **Quality indicator** - High variance suggests reliable count measurements
- ‚úÖ **Exploratory power** - Reveals major sources of microbiome variation

**Cons:**
- ‚ùå **No clinical relevance** - Doesn't consider relationship to outcomes
- ‚ùå **Noise sensitivity** - Technical variation can inflate variance in counts
- ‚ùå **Scale dependence** - Affected by count transformations and normalizations
- ‚ùå **Arbitrary selection** - "Top N" is subjective
- ‚ùå **Context ignorance** - May select microbes varying for non-biological reasons

**Limitations:**
- Doesn't distinguish biological from technical variation in counts
- Rare taxa may appear highly variable due to count sparsity
- Selection depends on study population characteristics

**Why Choose:** Useful for exploratory analyses to identify the most dynamic microbial abundance components.

**Expected Results:** Selects 20-100 most variable microbial count measurements from the microbial group

---

### **4. Univariate PFS Screening - PFS-Relevant Microbial Counts Only**
**Description:** Test each microbial abundance measurement individually against PFS using statistical models, keeping only those showing significant associations.

**Algorithm:**
```
For each microbial abundance measurement:
    # Fit univariate model: PFS ~ microbial_count
    model = fit_statistical_model(pfs_outcomes, microbial_count)

    if p_value < significance_threshold:
        keep_microbial_count
    else:
        discard_microbial_count
```

**Parameters:**
- Statistical test (Cox regression, log-rank test, etc.)
- Significance threshold (default: p < 0.05 or p < 0.2 for liberal screening)
- Multiple testing correction (Bonferroni, FDR, etc.)

**Pros:**
- ‚úÖ **Direct clinical relevance** - Only keeps microbial abundances associated with outcomes
- ‚úÖ **Statistical rigor** - Formal hypothesis testing for each microbial count
- ‚úÖ **Easy interpretation** - Clear inclusion criteria
- ‚úÖ **Biological insight** - Reveals which microbial abundances matter for disease progression
- ‚úÖ **Flexible thresholds** - Can adjust stringency based on study goals

**Cons:**
- ‚ùå **Ignores interactions** - May miss microbial abundances significant only in combination
- ‚ùå **Multiple testing issues** - Risk of false positives without correction
- ‚ùå **Conservative approach** - May exclude microbial counts with weak individual effects
- ‚ùå **Sample size dependence** - Power varies with number of events
- ‚ùå **Context independence** - Doesn't account for clinical covariates

**Limitations:**
- Requires sufficient PFS events for statistical power
- May miss synergistic effects between microbial abundances
- Results sensitive to censoring patterns

**Why Choose:** Essential for clinically focused analyses prioritizing outcome-relevant microbial counts.

**Expected Results:** Retains 5-30% of microbial abundance measurements showing PFS associations

---

### **5. Multivariate PFS Screening - Context-Aware Microbial Count Selection**
**Implementation:** Not yet implemented

**Description:** Test microbial abundance measurements in multivariate models including clinical variables, selecting those significant after adjusting for confounders.

**Algorithm:**
```python
# Fit full multivariate model: PFS ~ clinical_vars + all_microbial_counts
cph_full = CoxPHFitter(penalizer=0.1)  # Regularization for numerical stability
cph_full.fit(combined_data, duration_col='time', event_col='event')

# Extract significant microbial counts (p < 0.05 after clinical adjustment)
microbial_p_values = cph_full.p_values_[microbial_columns]
significant_microbial_counts = microbial_p_values[microbial_p_values < 0.05].index.tolist()

# Iterative refinement approach:
# 1. Start with all microbial counts + clinical variables
# 2. Remove non-significant microbial counts (p > 0.05)
# 3. Refit model with remaining microbial counts + clinical variables
# 4. Repeat until convergence or minimum microbial count
```

**Parameters:**
- Model type (Cox regression for PFS, logistic regression for binary outcomes)
- Significance threshold (default: p < 0.05, adjust for multiple testing)
- Clinical covariates (age, ISS, treatment duration, comorbidities)
- Regularization strength (default: 0.1 for numerical stability)
- Maximum iterations (default: 10 for iterative refinement)
- Minimum microbial counts to retain (default: 3-5 for model stability)

**Pros:**
- ‚úÖ **Clinically realistic** - Considers clinical context and confounding
- ‚úÖ **Context-aware** - Identifies microbial abundances significant beyond clinical factors
- ‚úÖ **Multivariate validity** - Accounts for microbial count intercorrelations
- ‚úÖ **Clinical translation** - Results relevant for patient stratification
- ‚úÖ **Confounding control** - Adjusts for known clinical predictors

**Cons:**
- ‚ùå **Computational intensity** - Requires fitting large multivariate models
- ‚ùå **Parameter instability** - Large models can be numerically unstable
- ‚ùå **Clinical variable dependence** - Results depend on which covariates are included
- ‚ùå **Overfitting risk** - Too many microbial counts relative to sample size
- ‚ùå **Interpretation complexity** - Hard to attribute effects to individual microbial abundances

**Limitations:**
- Requires sufficient sample size for multivariate model stability
- Sensitive to multicollinearity between microbial counts and clinical variables
- Clinical covariate selection affects which microbial abundances appear significant

**Why Choose:** Most clinically relevant approach for identifying microbial abundance measurements independently associated with PFS.

**Expected Results:** Retains 3-15 microbial abundance measurements significant in multivariate clinical context

---

### **6. Stability Selection - Robust PFS Associations for Microbial Counts**
**Description:** Use bootstrap resampling to identify microbial abundance measurements with consistently significant PFS associations across multiple subsamples.

**Algorithm:**
```
stability_scores = {}
n_bootstraps = 100

for microbial_count in microbial_counts:
    significant_count = 0

    for bootstrap_sample in generate_bootstraps(data, n_bootstraps):
        model = fit_pfs_model(bootstrap_sample['pfs'], bootstrap_sample[microbial_count])
        if model.p_value < 0.05:
            significant_count += 1

    stability_scores[microbial_count] = significant_count / n_bootstraps

select_microbial_counts_above_stability_threshold(stability_scores, threshold=0.7)
```

**Parameters:**
- Number of bootstrap samples (default: 100-1000)
- Stability threshold (default: 0.7 = significant in 70% of bootstraps)
- Bootstrap sample size (default: 80% of original sample size)
- Statistical test for each bootstrap

**Pros:**
- ‚úÖ **Robust identification** - Finds consistently associated microbial abundances
- ‚úÖ **Controls overfitting** - Reduces false positive selections
- ‚úÖ **Uncertainty quantification** - Provides confidence in selections
- ‚úÖ **Cross-validation built-in** - Bootstrap validation of associations
- ‚úÖ **Sample variability** - Accounts for population heterogeneity

**Cons:**
- ‚ùå **Computationally expensive** - Requires many model fits
- ‚ùå **Time-intensive** - May take hours for large microbial count sets
- ‚ùå **Parameter dependence** - Stability threshold affects results
- ‚ùå **Conservative bias** - May miss microbial counts with moderate associations

**Limitations:**
- Requires sufficient sample size for meaningful bootstrapping
- Assumes bootstrap samples represent population characteristics
- May be overly conservative for small datasets
- Computational cost scales with number of microbial abundance measurements

**Why Choose:** Essential for reproducible biomarker discovery with confidence measures for microbial counts.

**Expected Results:** Identifies 5-20 microbial abundance measurements with high stability scores (70%+ consistency)

---

### **7. Information-Theoretic Selection - Mutual Information for Microbial Counts**
**Description:** Select microbial abundance measurements based on mutual information with PFS outcomes, capturing non-linear and complex relationships.

**Algorithm:**
```
For each microbial abundance measurement:
    # Calculate mutual information I(microbial_count; pfs_outcome)
    mi_score = mutual_information(microbial_count, pfs_outcome)

    # Compare to null distribution (permuted PFS)
    p_value = calculate_mi_significance(mi_score, permuted_distributions)

select_microbial_counts_with_significant_mi(p_values, threshold)
```

**Parameters:**
- Mutual information estimator (histogram-based, k-nearest neighbors)
- Number of permutations for significance testing (default: 1000)
- Significance threshold (default: p < 0.05 after correction)

**Pros:**
- ‚úÖ **Non-linear relationships** - Captures complex microbial count-PFS associations
- ‚úÖ **No distribution assumptions** - Works with any abundance count distribution
- ‚úÖ **Information-theoretic foundation** - Solid theoretical basis
- ‚úÖ **Model independence** - Doesn't assume specific relationship form
- ‚úÖ **Robust to outliers** - Less sensitive to extreme count values

**Cons:**
- ‚ùå **Computational cost** - Especially for continuous count variables
- ‚ùå **Estimator sensitivity** - Results depend on binning or k parameter
- ‚ùå **Limited interpretability** - MI scores don't indicate relationship direction
- ‚ùå **Multiple testing** - Requires careful correction for many microbial counts

**Limitations:**
- Requires sufficient sample size for reliable MI estimation
- Sensitive to discretization parameters for continuous count variables
- Doesn't provide effect size or relationship direction
- May select redundant microbial counts with similar information content

**Why Choose:** Excellent for discovering non-linear microbiome count-PFS relationships that parametric methods might miss.

**Expected Results:** Selects 10-40 microbial abundance measurements with significant information shared with PFS

---

### **8. Boruta Algorithm - All-Relevant Microbial Count Selection**
**Description:** Iterative algorithm using random forest to identify all microbial abundance measurements with predictive relevance, not just the strongest ones.

**Algorithm:**
```
1. Add shadow features (randomized copies of real microbial counts)
2. Train random forest on all microbial abundance measurements
3. Compare real vs shadow feature importance
4. Iteratively remove microbial counts less important than best shadow
5. Stop when all remaining microbial counts > best shadow importance
```

**Parameters:**
- Number of shadow features per real microbial count (default: 1-5)
- Stopping criteria (max iterations, stability threshold)
- Random forest parameters (number of trees, max depth)

**Pros:**
- ‚úÖ **All-relevant selection** - Finds all predictive microbial abundances, not just top performers
- ‚úÖ **Statistical foundation** - Uses permutation testing for significance
- ‚úÖ **Handles correlations** - Works well with correlated microbial abundance features
- ‚úÖ **Robust to overfitting** - Ensemble method reduces variance
- ‚úÖ **No parameter tuning** - Algorithm determines optimal microbial count set

**Cons:**
- ‚ùå **Computationally intensive** - Multiple random forest trainings
- ‚ùå **Time-consuming** - May take significant time for large datasets
- ‚ùå **Memory intensive** - Random forest objects for each iteration
- ‚ùå **Random forest dependence** - Results depend on RF implementation
- ‚ùå **May be overly inclusive** - Includes marginally relevant microbial counts

**Limitations:**
- Requires sufficient sample size for stable random forest importance
- May be conservative in small datasets
- Computational requirements may be prohibitive for very large microbial count sets

**Why Choose:** Ideal for comprehensive biomarker discovery ensuring no important microbial abundance measurements are missed.

**Expected Results:** Selects 15-50 microbial abundance measurements with confirmed predictive relevance

---

### **9. Elastic Net Regularization - Automated Microbial Count Selection**
**Description:** Use L1/L2 regularized regression to automatically select microbial abundance measurements with PFS predictive value through coefficient shrinkage.

**Algorithm:**
```
# Optimize elastic net: minimize loss + Œª‚ÇÅ||Œ≤||‚ÇÅ + Œª‚ÇÇ||Œ≤||‚ÇÇ
# L1 penalty drives irrelevant microbial counts to zero
# L2 penalty handles correlations

selected_microbial_counts = microbial_counts_with_nonzero_coefficients(final_model)
```

**Parameters:**
- L1 ratio (balance between L1 and L2, default: 0.5)
- Regularization strength Œª (chosen by cross-validation)
- Maximum iterations (default: 1000)
- Convergence tolerance

**Pros:**
- ‚úÖ **Automated selection** - No manual threshold setting required
- ‚úÖ **Handles correlations** - L2 component manages multicollinear microbial abundances
- ‚úÖ **Continuous selection** - Gradual elimination rather than hard cutoffs
- ‚úÖ **Cross-validation built-in** - Automatic parameter optimization
- ‚úÖ **Predictive focus** - Selects for outcome prediction performance

**Cons:**
- ‚ùå **Model dependence** - Results depend on chosen base model
- ‚ùå **Linear assumptions** - Assumes linear relationships for selection
- ‚ùå **Parameter sensitivity** - Regularization balance affects results
- ‚ùå **May miss weak signals** - Conservative selection approach
- ‚ùå **Computational cost** - Especially for large microbial count sets

**Limitations:**
- Requires specification of base regression model
- Selection depends on regularization parameter choice
- May not capture non-linear microbial count-PFS relationships
- Cross-validation can be computationally expensive

**Why Choose:** Provides automated, statistically principled microbial abundance selection with built-in correlation handling.

**Expected Results:** Selects 5-25 microbial abundance measurements with non-zero coefficients in regularized model

---

### **10. Combined Multi-Method Selection for Microbial Counts**
**Description:** Apply multiple selection methods and take consensus or intersection to identify robustly selected microbial abundance measurements.

**Algorithm:**
```
# Apply multiple methods
method1_microbial_counts = apply_method1(data, parameters1)
method2_microbial_counts = apply_method2(data, parameters2)
method3_microbial_counts = apply_method3(data, parameters3)

# Consensus approaches:
# Intersection: microbial counts selected by ALL methods
# Union: microbial counts selected by ANY method
# Weighted: microbial counts selected by multiple methods get higher priority
```

**Parameters:**
- Methods to combine (select 2-4 complementary approaches)
- Consensus rule (intersection, union, weighted voting)
- Minimum agreement threshold (for weighted approaches)

**Pros:**
- ‚úÖ **Robust selection** - Microbial abundance measurements selected by multiple methods are more reliable
- ‚úÖ **Method validation** - Cross-validation of different approaches
- ‚úÖ **Comprehensive coverage** - Captures different types of associations
- ‚úÖ **Uncertainty reduction** - Reduces method-specific biases
- ‚úÖ **Confidence building** - Multiple lines of evidence for selected microbial counts

**Cons:**
- ‚ùå **Computational cost** - Running multiple methods increases time
- ‚ùå **Result complexity** - Different methods may give different answers
- ‚ùå **Decision complexity** - Choosing how to combine results
- ‚ùå **Conservative bias** - Strict consensus may miss valid microbial abundances
- ‚ùå **Method dependence** - Results depend on which methods are combined

**Limitations:**
- Requires careful consideration of which methods to combine
- Consensus rules are somewhat arbitrary
- May miss microbial abundance measurements only detectable by specific methods
- Interpretation becomes more complex

**Why Choose:** Essential for high-confidence biomarker discovery with validation across multiple approaches for microbial counts.

**Expected Results:** Highly confident selection of 5-20 microbial abundance measurements supported by multiple methods

---

## üéØ Implementation Strategy

### **Recommended Selection Pipeline:**
```
Phase 1: Quality Control (Implemented)
‚îú‚îÄ‚îÄ 1. Prevalence Filtering ‚Üí Remove measurement artifacts
‚îî‚îÄ‚îÄ 2. Abundance Filtering ‚Üí Focus on ecologically relevant microbial abundances

Phase 2: Clinical Relevance (Mixed implementation)
‚îú‚îÄ‚îÄ 3. PFS-Univariate Screening ‚Üí Identify clinically relevant microbial counts (Implemented)
‚îú‚îÄ‚îÄ 4. PFS-Stability Selection ‚Üí Ensure robust associations (Not implemented)
‚îî‚îÄ‚îÄ 5. Multivariate PFS Screening ‚Üí Confirm clinical context relevance (Not implemented)

Phase 3: Advanced Validation (Not implemented)
‚îú‚îÄ‚îÄ 6. Information-Theoretic Selection ‚Üí Capture complex relationships
‚îú‚îÄ‚îÄ 7. Boruta Algorithm ‚Üí All-relevant microbial count selection
‚îú‚îÄ‚îÄ 8. LASSO Regularization ‚Üí Automated sparse selection
‚îî‚îÄ‚îÄ 9. Combined Multi-Method ‚Üí Consensus validation
```

### **Alternative Strategies:**

#### **Conservative Approach (High Confidence, Clinical Focus):**
- Use intersection of PFS-aware methods only
- Best for clinical applications requiring maximum certainty
- May miss some valid microbial abundances but ensures clinical relevance

#### **Comprehensive Approach (Max Coverage, Discovery Focus):**
- Use union of all applicable methods
- Best for exploratory research to avoid missing potential biomarkers
- Requires careful validation to avoid false positives

#### **Staged Approach (Balanced, Recommended):**
- Start with liberal criteria (higher p-values, lower stability thresholds)
- Apply increasingly stringent filters in later stages
- Best for balancing discovery potential with clinical utility

### **Quality Control Checkpoints:**
- **After filtering steps:** Verify biologically important microbes aren't inappropriately discarded
- **After PFS screening:** Ensure selected microbial abundances have plausible mechanistic associations
- **After stability validation:** Confirm selections are reproducible across data subsets
- **After multivariate screening:** Validate associations hold in full clinical context
- **Final validation:** Cross-reference with existing literature and biological knowledge

### **Parameter Selection Guidelines:**
- **Prevalence threshold:** 5-15% depending on sequencing depth (lower for deep sequencing)
- **Abundance threshold:** 1-50 counts depending on sequencing depth (check data distribution)
- **PFS significance:** p < 0.05 for discovery, p < 0.01 for validation studies
- **Stability threshold:** 70-80% consistency across bootstrap samples
- **Clinical covariates:** Always include age, ISS stage, treatment type as minimum

This microbial count selection phase transforms your biologically grouped microbial abundances into a focused, high-quality dataset optimized for downstream PFS correlation analysis.