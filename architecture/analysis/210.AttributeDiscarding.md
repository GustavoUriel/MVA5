# 210.AttributeDiscarding.md: Variable Selection/Discard Methods

This document presents **variable selection and discard methods** to reduce dimensionality after microbial grouping, removing noise while preserving biologically relevant signals.

---

## üéØ Phase 2 Overview

**Goal:** Reduce the selected microbial taxa (potentially hundreds) to the most informative variables (10-50) for downstream analysis.

**Why After Microbial Grouping:** Start with biologically relevant microbes, then refine based on data quality and statistical properties.

---

## üìä Variable Selection/Discard Methods

### **1. Prevalence Filtering - Remove Rare Taxa**
**Description:** Discard taxa present in fewer than a specified percentage of samples, removing unreliable measurements.

**Algorithm:**
```
For each taxon:
    prevalence = (abundance > detection_threshold).sum() / total_samples
    if prevalence < min_prevalence_threshold:
        discard_taxon
```

**Parameters:**
- Detection threshold (default: >0)
- Minimum prevalence (default: 10% of samples)

**Pros:**
- ‚úÖ **Data quality control** - Eliminates measurement artifacts and rare taxa
- ‚úÖ **Statistical reliability** - Focuses on consistently detectable microbes
- ‚úÖ **Computational efficiency** - Reduces dataset size significantly
- ‚úÖ **Reproducibility** - Removes taxa with unreliable abundance estimates
- ‚úÖ **Simple implementation** - Easy to understand and apply

**Cons:**
- ‚ùå **May discard important taxa** - Some biologically relevant microbes may be rare
- ‚ùå **Arbitrary thresholds** - Prevalence cutoff is subjective
- ‚ùå **Context dependence** - Optimal prevalence varies by study design and technology
- ‚ùå **False negatives** - Rare pathogens or keystone species may be excluded

**Limitations:**
- Doesn't consider abundance levels, only presence/absence
- May be too conservative for some research questions
- Threshold selection requires biological knowledge

**Why Choose:** Essential first step for data quality control in microbiome studies.

**Expected Results:** Reduces taxa count by 20-60%, depending on threshold

---

### **2. Abundance Filtering - Remove Low-Abundance Taxa**
**Description:** Discard taxa with consistently low abundance across samples, focusing on ecologically important microbes.

**Algorithm:**
```
For each taxon:
    mean_abundance = taxon_abundances.mean()
    median_abundance = taxon_abundances.median()
    max_abundance = taxon_abundances.max()

    if mean_abundance < min_mean_threshold or median_abundance < min_median_threshold:
        discard_taxon
```

**Parameters:**
- Minimum mean abundance (default: 0.01% relative abundance)
- Minimum median abundance (default: 0.005% relative abundance)
- Optional maximum abundance filtering

**Pros:**
- ‚úÖ **Ecological relevance** - Focuses on microbes that contribute meaningfully to community
- ‚úÖ **Measurement precision** - Removes taxa near detection limits
- ‚úÖ **Biological signal** - Prioritizes microbes with functional impact
- ‚úÖ **Data normalization** - Complements relative abundance transformations
- ‚úÖ **Statistical power** - Reduces noise in downstream analyses

**Cons:**
- ‚ùå **Context dependence** - Abundance thresholds vary by sample type and technology
- ‚ùå **Functional bias** - May exclude important low-abundance functional specialists
- ‚ùå **Normalization effects** - Results depend on abundance transformation method
- ‚ùå **Sample variability** - Abundance distributions vary across studies

**Limitations:**
- Requires appropriate abundance normalization (relative abundance, CLR, etc.)
- May miss conditionally abundant taxa (bloomers under specific conditions)
- Thresholds need validation against biological knowledge

**Why Choose:** Complements prevalence filtering by focusing on ecologically significant microbes.

**Expected Results:** Further reduces taxa count by 10-40%, depending on thresholds

---

### **3. Variance-Based Selection - Keep Most Variable Taxa**
**Description:** Select taxa with highest variance across samples, identifying microbes that differ between patients or conditions.

**Algorithm:**
```
For each taxon:
    variance = taxon_abundances.var()
    coefficient_of_variation = variance / mean_abundance

    rank_taxa_by_variance()
    select_top_n_most_variable()
```

**Parameters:**
- Number of taxa to select (default: 50)
- Variance metric (total variance, coefficient of variation)
- Optional weighting by mean abundance

**Pros:**
- ‚úÖ **Biological heterogeneity** - Identifies taxa that vary between individuals
- ‚úÖ **Condition differences** - Captures microbes that change with disease states
- ‚úÖ **Data-driven** - No biological assumptions required
- ‚úÖ **Quality indicator** - High variance suggests reliable measurements
- ‚úÖ **Exploratory power** - Reveals major sources of microbiome variation

**Cons:**
- ‚ùå **No clinical relevance** - Doesn't consider relationship to outcomes
- ‚ùå **Noise sensitivity** - Technical variation can inflate variance
- ‚ùå **Scale dependence** - Affected by abundance transformations
- ‚ùå **Arbitrary selection** - "Top N" is subjective
- ‚ùå **Context ignorance** - May select taxa varying for non-biological reasons

**Limitations:**
- Doesn't distinguish biological from technical variation
- Rare taxa may appear highly variable due to sparsity
- Selection depends on study population characteristics

**Why Choose:** Useful for exploratory analyses to identify the most dynamic microbial components.

**Expected Results:** Selects 20-100 most variable taxa from the microbial group

---

### **4. Univariate PFS Screening - PFS-Relevant Taxa Only**
**Description:** Test each taxon individually against PFS using statistical models, keeping only those showing significant associations.

**Algorithm:**
```
For each taxon:
    # Fit univariate model: PFS ~ taxon_abundance
    model = fit_statistical_model(pfs_outcomes, taxon_abundance)

    if p_value < significance_threshold:
        keep_taxon
    else:
        discard_taxon
```

**Parameters:**
- Statistical test (Cox regression, log-rank test, etc.)
- Significance threshold (default: p < 0.05 or p < 0.2 for liberal screening)
- Multiple testing correction (Bonferroni, FDR, etc.)

**Pros:**
- ‚úÖ **Direct clinical relevance** - Only keeps taxa associated with outcomes
- ‚úÖ **Statistical rigor** - Formal hypothesis testing for each taxon
- ‚úÖ **Easy interpretation** - Clear inclusion criteria
- ‚úÖ **Biological insight** - Reveals which microbes matter for disease progression
- ‚úÖ **Flexible thresholds** - Can adjust stringency based on study goals

**Cons:**
- ‚ùå **Ignores interactions** - May miss taxa significant only in combination
- ‚ùå **Multiple testing issues** - Risk of false positives without correction
- ‚ùå **Conservative approach** - May exclude taxa with weak individual effects
- ‚ùå **Sample size dependence** - Power varies with number of events
- ‚ùå **Context independence** - Doesn't account for clinical covariates

**Limitations:**
- Requires sufficient PFS events for statistical power
- May miss synergistic effects between taxa
- Results sensitive to censoring patterns

**Why Choose:** Essential for clinically focused analyses prioritizing outcome-relevant microbes.

**Expected Results:** Retains 5-30% of taxa showing PFS associations

---

### **5. Multivariate PFS Screening - Context-Aware Selection**
**Implementation:** Not yet implemented

**Description:** Test taxa in multivariate models including clinical variables, selecting those significant after adjusting for confounders.

**Algorithm:**
```python
# Fit full multivariate model: PFS ~ clinical_vars + all_taxa
cph_full = CoxPHFitter(penalizer=0.1)  # Regularization for numerical stability
cph_full.fit(combined_data, duration_col='time', event_col='event')

# Extract significant taxa (p < 0.05 after clinical adjustment)
taxa_p_values = cph_full.p_values_[taxa_columns]
significant_taxa = taxa_p_values[taxa_p_values < 0.05].index.tolist()

# Iterative refinement approach:
# 1. Start with all taxa + clinical variables
# 2. Remove non-significant taxa (p > 0.05)
# 3. Refit model with remaining taxa + clinical variables
# 4. Repeat until convergence or minimum taxa count
```

**Parameters:**
- Model type (Cox regression for PFS, logistic regression for binary outcomes)
- Significance threshold (default: p < 0.05, adjust for multiple testing)
- Clinical covariates (age, ISS, treatment duration, comorbidities)
- Regularization strength (default: 0.1 for numerical stability)
- Maximum iterations (default: 10 for iterative refinement)
- Minimum taxa to retain (default: 3-5 for model stability)

**Pros:**
- ‚úÖ **Clinically realistic** - Considers clinical context and confounding
- ‚úÖ **Context-aware** - Identifies taxa significant beyond clinical factors
- ‚úÖ **Multivariate validity** - Accounts for taxon intercorrelations
- ‚úÖ **Clinical translation** - Results relevant for patient stratification
- ‚úÖ **Confounding control** - Adjusts for known clinical predictors

**Cons:**
- ‚ùå **Computational intensity** - Requires fitting large multivariate models
- ‚ùå **Parameter instability** - Large models can be numerically unstable
- ‚ùå **Clinical variable dependence** - Results depend on which covariates are included
- ‚ùå **Overfitting risk** - Too many taxa relative to sample size
- ‚ùå **Interpretation complexity** - Hard to attribute effects to individual taxa

**Limitations:**
- Requires sufficient sample size for multivariate model stability
- Sensitive to multicollinearity between taxa and clinical variables
- Clinical covariate selection affects which taxa appear significant

**Why Choose:** Most clinically relevant approach for identifying microbes independently associated with PFS.

**Expected Results:** Retains 3-15 taxa significant in multivariate clinical context

---

### **6. Stability Selection - Robust PFS Associations**
**Description:** Use bootstrap resampling to identify taxa with consistently significant PFS associations across multiple subsamples.

**Algorithm:**
```
stability_scores = {}
n_bootstraps = 100

for taxon in taxa:
    significant_count = 0

    for bootstrap_sample in generate_bootstraps(data, n_bootstraps):
        model = fit_pfs_model(bootstrap_sample['pfs'], bootstrap_sample[taxon])
        if model.p_value < 0.05:
            significant_count += 1

    stability_scores[taxon] = significant_count / n_bootstraps

select_taxa_above_stability_threshold(stability_scores, threshold=0.7)
```

**Parameters:**
- Number of bootstrap samples (default: 100-1000)
- Stability threshold (default: 0.7 = significant in 70% of bootstraps)
- Bootstrap sample size (default: 80% of original sample size)
- Statistical test for each bootstrap

**Pros:**
- ‚úÖ **Robust identification** - Finds consistently associated taxa
- ‚úÖ **Controls overfitting** - Reduces false positive selections
- ‚úÖ **Uncertainty quantification** - Provides confidence in selections
- ‚úÖ **Cross-validation built-in** - Bootstrap validation of associations
- ‚úÖ **Sample variability** - Accounts for population heterogeneity

**Cons:**
- ‚ùå **Computationally expensive** - Requires many model fits
- ‚ùå **Time-intensive** - May take hours for large taxon sets
- ‚ùå **Parameter dependence** - Stability threshold affects results
- ‚ùå **Conservative bias** - May miss taxa with moderate associations

**Limitations:**
- Requires sufficient sample size for meaningful bootstrapping
- Assumes bootstrap samples represent population characteristics
- May be overly conservative for small datasets
- Computational cost scales with number of taxa

**Why Choose:** Essential for reproducible biomarker discovery with confidence measures.

**Expected Results:** Identifies 5-20 taxa with high stability scores (70%+ consistency)

---

### **7. Information-Theoretic Selection - Mutual Information**
**Description:** Select taxa based on mutual information with PFS outcomes, capturing non-linear and complex relationships.

**Algorithm:**
```
For each taxon:
    # Calculate mutual information I(taxon_abundance; pfs_outcome)
    mi_score = mutual_information(taxon_abundance, pfs_outcome)

    # Compare to null distribution (permuted PFS)
    p_value = calculate_mi_significance(mi_score, permuted_distributions)

select_taxa_with_significant_mi(p_values, threshold)
```

**Parameters:**
- Mutual information estimator (histogram-based, k-nearest neighbors)
- Number of permutations for significance testing (default: 1000)
- Significance threshold (default: p < 0.05 after correction)

**Pros:**
- ‚úÖ **Non-linear relationships** - Captures complex taxon-PFS associations
- ‚úÖ **No distribution assumptions** - Works with any abundance distribution
- ‚úÖ **Information-theoretic foundation** - Solid theoretical basis
- ‚úÖ **Model independence** - Doesn't assume specific relationship form
- ‚úÖ **Robust to outliers** - Less sensitive to extreme values

**Cons:**
- ‚ùå **Computational cost** - Especially for continuous variables
- ‚ùå **Estimator sensitivity** - Results depend on binning or k parameter
- ‚ùå **Limited interpretability** - MI scores don't indicate relationship direction
- ‚ùå **Multiple testing** - Requires careful correction for many taxa

**Limitations:**
- Requires sufficient sample size for reliable MI estimation
- Sensitive to discretization parameters for continuous variables
- Doesn't provide effect size or relationship direction
- May select redundant taxa with similar information content

**Why Choose:** Excellent for discovering non-linear microbiome-PFS relationships that parametric methods might miss.

**Expected Results:** Selects 10-40 taxa with significant information shared with PFS

---

### **8. Boruta Algorithm - All-Relevant Feature Selection**
**Description:** Iterative algorithm using random forest to identify all features with predictive relevance, not just the strongest ones.

**Algorithm:**
```
1. Add shadow features (randomized copies of real taxa)
2. Train random forest on all features
3. Compare real vs shadow feature importance
4. Iteratively remove features less important than best shadow
5. Stop when all remaining features > best shadow importance
```

**Parameters:**
- Number of shadow features per real feature (default: 1-5)
- Stopping criteria (max iterations, stability threshold)
- Random forest parameters (number of trees, max depth)

**Pros:**
- ‚úÖ **All-relevant selection** - Finds all predictive taxa, not just top performers
- ‚úÖ **Statistical foundation** - Uses permutation testing for significance
- ‚úÖ **Handles correlations** - Works well with correlated microbial features
- ‚úÖ **Robust to overfitting** - Ensemble method reduces variance
- ‚úÖ **No parameter tuning** - Algorithm determines optimal feature set

**Cons:**
- ‚ùå **Computationally intensive** - Multiple random forest trainings
- ‚ùå **Time-consuming** - May take significant time for large datasets
- ‚ùå **Memory intensive** - Random forest objects for each iteration
- ‚ùå **Random forest dependence** - Results depend on RF implementation
- ‚ùå **May be overly inclusive** - Includes marginally relevant features

**Limitations:**
- Requires sufficient sample size for stable random forest importance
- May be conservative in small datasets
- Computational requirements may be prohibitive for very large feature sets

**Why Choose:** Ideal for comprehensive biomarker discovery ensuring no important taxa are missed.

**Expected Results:** Selects 15-50 taxa with confirmed predictive relevance

---

### **9. Elastic Net Regularization - Automated Selection**
**Description:** Use L1/L2 regularized regression to automatically select taxa with PFS predictive value through coefficient shrinkage.

**Algorithm:**
```
# Optimize elastic net: minimize loss + Œª‚ÇÅ||Œ≤||‚ÇÅ + Œª‚ÇÇ||Œ≤||‚ÇÇ
# L1 penalty drives irrelevant taxa to zero
# L2 penalty handles correlations

selected_taxa = taxa_with_nonzero_coefficients(final_model)
```

**Parameters:**
- L1 ratio (balance between L1 and L2, default: 0.5)
- Regularization strength Œª (chosen by cross-validation)
- Maximum iterations (default: 1000)
- Convergence tolerance

**Pros:**
- ‚úÖ **Automated selection** - No manual threshold setting required
- ‚úÖ **Handles correlations** - L2 component manages multicollinear taxa
- ‚úÖ **Continuous selection** - Gradual elimination rather than hard cutoffs
- ‚úÖ **Cross-validation built-in** - Automatic parameter optimization
- ‚úÖ **Predictive focus** - Selects for outcome prediction performance

**Cons:**
- ‚ùå **Model dependence** - Results depend on chosen base model
- ‚ùå **Linear assumptions** - Assumes linear relationships for selection
- ‚ùå **Parameter sensitivity** - Regularization balance affects results
- ‚ùå **May miss weak signals** - Conservative selection approach
- ‚ùå **Computational cost** - Especially for large feature sets

**Limitations:**
- Requires specification of base regression model
- Selection depends on regularization parameter choice
- May not capture non-linear taxon-PFS relationships
- Cross-validation can be computationally expensive

**Why Choose:** Provides automated, statistically principled feature selection with built-in correlation handling.

**Expected Results:** Selects 5-25 taxa with non-zero coefficients in regularized model

---

### **10. Combined Multi-Method Selection**
**Description:** Apply multiple selection methods and take consensus or intersection to identify robustly selected taxa.

**Algorithm:**
```
# Apply multiple methods
method1_taxa = apply_method1(data, parameters1)
method2_taxa = apply_method2(data, parameters2)
method3_taxa = apply_method3(data, parameters3)

# Consensus approaches:
# Intersection: taxa selected by ALL methods
# Union: taxa selected by ANY method
# Weighted: taxa selected by multiple methods get higher priority
```

**Parameters:**
- Methods to combine (select 2-4 complementary approaches)
- Consensus rule (intersection, union, weighted voting)
- Minimum agreement threshold (for weighted approaches)

**Pros:**
- ‚úÖ **Robust selection** - Taxa selected by multiple methods are more reliable
- ‚úÖ **Method validation** - Cross-validation of different approaches
- ‚úÖ **Comprehensive coverage** - Captures different types of associations
- ‚úÖ **Uncertainty reduction** - Reduces method-specific biases
- ‚úÖ **Confidence building** - Multiple lines of evidence for selected taxa

**Cons:**
- ‚ùå **Computational cost** - Running multiple methods increases time
- ‚ùå **Result complexity** - Different methods may give different answers
- ‚ùå **Decision complexity** - Choosing how to combine results
- ‚ùå **Conservative bias** - Strict consensus may miss valid taxa
- ‚ùå **Method dependence** - Results depend on which methods are combined

**Limitations:**
- Requires careful consideration of which methods to combine
- Consensus rules are somewhat arbitrary
- May miss taxa only detectable by specific methods
- Interpretation becomes more complex

**Why Choose:** Essential for high-confidence biomarker discovery with validation across multiple approaches.

**Expected Results:** Highly confident selection of 5-20 taxa supported by multiple methods

---

## üéØ Implementation Strategy

### **Recommended Selection Pipeline:**
```
Phase 1: Quality Control (Implemented)
‚îú‚îÄ‚îÄ 1. Prevalence Filtering ‚Üí Remove measurement artifacts
‚îî‚îÄ‚îÄ 2. Abundance Filtering ‚Üí Focus on ecologically relevant taxa

Phase 2: Clinical Relevance (Mixed implementation)
‚îú‚îÄ‚îÄ 3. PFS-Univariate Screening ‚Üí Identify clinically relevant taxa (Implemented)
‚îú‚îÄ‚îÄ 4. PFS-Stability Selection ‚Üí Ensure robust associations (Not implemented)
‚îî‚îÄ‚îÄ 5. Multivariate PFS Screening ‚Üí Confirm clinical context relevance (Not implemented)

Phase 3: Advanced Validation (Not implemented)
‚îú‚îÄ‚îÄ 6. Information-Theoretic Selection ‚Üí Capture complex relationships
‚îú‚îÄ‚îÄ 7. Boruta Algorithm ‚Üí All-relevant feature selection
‚îú‚îÄ‚îÄ 8. LASSO Regularization ‚Üí Automated sparse selection
‚îî‚îÄ‚îÄ 9. Combined Multi-Method ‚Üí Consensus validation
```

### **Alternative Strategies:**

#### **Conservative Approach (High Confidence, Clinical Focus):**
- Use intersection of PFS-aware methods only
- Best for clinical applications requiring maximum certainty
- May miss some valid taxa but ensures clinical relevance

#### **Comprehensive Approach (Max Coverage, Discovery Focus):**
- Use union of all applicable methods
- Best for exploratory research to avoid missing potential biomarkers
- Requires careful validation to avoid false positives

#### **Staged Approach (Balanced, Recommended):**
- Start with liberal criteria (higher p-values, lower stability thresholds)
- Apply increasingly stringent filters in later stages
- Best for balancing discovery potential with clinical utility

### **Quality Control Checkpoints:**
- **After filtering steps:** Verify biologically important taxa aren't inappropriately discarded
- **After PFS screening:** Ensure selected taxa have plausible mechanistic associations
- **After stability validation:** Confirm selections are reproducible across data subsets
- **After multivariate screening:** Validate associations hold in full clinical context
- **Final validation:** Cross-reference with existing literature and biological knowledge

### **Parameter Selection Guidelines:**
- **Prevalence threshold:** 5-15% depending on sequencing depth (lower for deep sequencing)
- **Abundance threshold:** 0.005-0.05% relative abundance (check data distribution)
- **PFS significance:** p < 0.05 for discovery, p < 0.01 for validation studies
- **Stability threshold:** 70-80% consistency across bootstrap samples
- **Clinical covariates:** Always include age, ISS stage, treatment type as minimum

This variable selection phase transforms your biologically grouped microbes into a focused, high-quality dataset optimized for downstream PFS correlation analysis.