# 250.MVAMethods.md: Multivariate PFS Correlation Analysis

This document presents **multivariate analysis methods** that establish statistical correlations between selected microbial groups and Progression-Free Survival (PFS) in Multiple Myeloma patients.

---

## üéØ Phase 5 Overview

**Goal:** Apply multivariate methods to the final selected groups (3-8) to establish robust statistical correlations with PFS outcomes and clinical variables.

**Why Final Phase:** Requires clean, validated groups to handle the complexity of microbiome-clinical relationships without overfitting.

---

## üìä Multivariate PFS Correlation Methods

### **1. Cox Proportional Hazards Regression**
**Implementation:** `cox_regression_analysis.py`, `cox_regression_all_datapoints.py` - `CoxPHFitter`

**Description:** Primary method for establishing PFS correlations, modeling hazard ratios between microbial groups and relapse risk while controlling for clinical variables.

**Mathematical Foundation:**
```
h(t|X) = h‚ÇÄ(t) √ó exp(Œ≤‚ÇÅG‚ÇÅ + Œ≤‚ÇÇG‚ÇÇ + ... + Œ≤‚ÇñG‚Çñ + Œ≤‚Çñ‚Çä‚ÇÅC‚ÇÅ + ... + Œ≤‚ÇöC‚Çò)
```
Where:
- `G·µ¢` = microbial group features
- `C‚±º` = clinical covariates (age, ISS, etc.)
- `Œ≤·µ¢` = regression coefficients (log hazard ratios)

**Pros:**
- ‚úÖ **Gold standard for PFS analysis** - Specifically designed for time-to-event data
- ‚úÖ **Clinically interpretable** - Hazard ratios directly indicate risk magnitude
- ‚úÖ **Handles censoring** - Accounts for patients lost to follow-up
- ‚úÖ **Flexible covariates** - Integrates microbial and clinical variables
- ‚úÖ **Proportional hazards testing** - Can validate model assumptions

**Cons:**
- ‚ùå **Assumption dependent** - Requires proportional hazards assumption
- ‚ùå **Non-linear limitations** - Assumes linear effects on log hazard
- ‚ùå **High-dimensional challenges** - Needs validated groups for stability
- ‚ùå **Computational intensity** - Multiple iterations for large datasets

**Limitations:**
- Requires sufficient events for stable estimates
- Sensitive to multicollinearity between groups
- May miss complex non-linear PFS relationships
- Censoring patterns can bias results

**Why Choose:** Provides the most clinically interpretable and statistically rigorous PFS correlations, serving as the foundation for all other analyses.

**Expected PFS Correlations:** Hazard ratios >2.0 for high-risk groups, p < 0.05 for significant associations

---

### **2. Partial Least Squares for Survival (PLS-Survival)**
**Implementation:** Supervised extension of PLS adapted for censored survival data

**Description:** Finds latent variables maximizing covariance between microbial groups and PFS outcomes, providing interpretable microbial-PFS relationships.

**Mathematical Foundation:**
```
# Supervised PLS for survival:
X = T √ó P·µÄ + E‚Çì    (Microbial groups)
Y = T √ó Q·µÄ + E·µß    (PFS outcomes)

Maximize: Cov(T, survival_time)
Subject to: T optimally predicts PFS
```

**Pros:**
- ‚úÖ **Direct PFS integration** - Supervised method using survival as outcome
- ‚úÖ **Handles multicollinearity** - Designed for correlated microbial groups
- ‚úÖ **Dimensionality reduction** - Creates interpretable latent factors
- ‚úÖ **Variable importance** - Provides VIP scores for microbial groups
- ‚úÖ **Predictive modeling** - Can generate PFS risk scores from latent factors

**Cons:**
- ‚ùå **Complex interpretation** - Latent variables are linear combinations
- ‚ùå **Parameter selection** - Number of components affects results
- ‚ùå **Less established for survival** - Primarily developed for continuous outcomes
- ‚ùå **Assumes linearity** - May miss non-linear microbiome-PFS relationships

**Limitations:**
- Requires cross-validation for component selection
- VIP scores depend on chosen number of components
- May not handle censoring as elegantly as Cox regression

**Why Choose:** Complements Cox regression by providing dimensionality reduction and feature importance metrics.

**Expected PFS Correlations:** Significant latent factors (p < 0.05), VIP scores >1.0 for relevant groups

---

### **3. Random Survival Forests**
**Implementation:** Ensemble method extending random forests to censored survival data

**Description:** Builds multiple survival trees to capture complex, non-linear relationships between microbial groups and PFS.

**Algorithm:**
1. Bootstrap sampling of training data
2. Random feature selection at each split
3. Survival tree construction using log-rank splitting
4. Ensemble prediction averaging across trees

**Pros:**
- ‚úÖ **Non-linear PFS modeling** - Captures complex microbial interactions
- ‚úÖ **Robust to outliers** - Tree-based method resistant to extreme values
- ‚úÖ **Variable importance** - Provides feature rankings by PFS prediction contribution
- ‚úÖ **No distribution assumptions** - Non-parametric approach
- ‚úÖ **Handles mixed data types** - Works with grouped features and clinical variables

**Cons:**
- ‚ùå **Black box nature** - Difficult to interpret individual predictions
- ‚ùå **Computational intensity** - Training many trees is expensive
- ‚ùå **Parameter tuning** - Number of trees, max depth, etc.
- ‚ùå **Memory intensive** - Large forest objects for high-dimensional data
- ‚ùå **Overfitting potential** - Especially with small datasets

**Limitations:**
- Requires sufficient sample size for stable forests
- Variable importance can be unstable across runs
- May not perform well with very high-dimensional data

**Why Choose:** Essential for detecting non-linear PFS relationships that Cox regression might miss.

**Expected PFS Correlations:** Variable importance scores, non-linear interaction effects

---

### **4. Sparse Partial Least Squares Discriminant Analysis (sPLS-DA)**
**Implementation:** Supervised sparse PLS-DA for PFS outcome discrimination and feature selection

**Description:** Performs simultaneous feature selection and PFS-based discrimination using microbial groups.

**Algorithm:**
1. PLS dimension reduction with PFS as outcome
2. L1 regularization for automatic feature sparsity
3. Discriminant analysis on reduced space
4. Iterative optimization for PFS-relevant feature selection

**Pros:**
- ‚úÖ **Direct PFS supervision** - Uses PFS outcomes for group discrimination
- ‚úÖ **Automatic feature selection** - Built-in sparsity identifies PFS-relevant groups
- ‚úÖ **Multiclass discrimination** - Can handle early/late relapse classification
- ‚úÖ **Handles correlations** - Designed for correlated microbial groups
- ‚úÖ **Predictive performance** - Good classification accuracy for PFS groups

**Cons:**
- ‚ùå **Complexity** - Multiple tuning parameters (sparsity, components)
- ‚ùå **Computational cost** - Iterative optimization algorithms
- ‚ùå **Parameter sensitivity** - Sparsity parameter affects selected groups
- ‚ùå **Limited survival extension** - Primarily developed for classification

**Limitations:**
- Requires outcome variable for supervision
- May select groups that discriminate well but aren't biologically relevant
- Cross-validation essential for parameter tuning

**Why Choose:** Provides automated group selection specifically for PFS discrimination.

**Expected PFS Correlations:** Clear separation between PFS groups in reduced space

---

### **5. Neural Network Approaches: Survival Neural Networks**
**Implementation:** Deep learning models adapted for PFS analysis using microbial groups

**Description:** Uses neural networks to model complex, non-linear relationships between microbial groups and PFS outcomes.

**Architecture:**
- Input layer: microbial group features + clinical variables
- Hidden layers: non-linear feature extraction
- Output: hazard function or PFS probability
- Loss: negative log partial likelihood for survival

**Pros:**
- ‚úÖ **Non-linear PFS modeling** - Captures complex microbial interactions
- ‚úÖ **Feature learning** - Automatically discovers PFS-relevant patterns
- ‚úÖ **Flexibility** - Can incorporate various data types and interactions
- ‚úÖ **Scalability** - Handles large numbers of grouped features
- ‚úÖ **End-to-end learning** - Joint optimization of feature extraction and PFS prediction

**Cons:**
- ‚ùå **Black box nature** - Poor interpretability of PFS correlations
- ‚ùå **Data hungry** - Requires large training sets for reliable PFS modeling
- ‚ùå **Computational cost** - Expensive training and inference
- ‚ùå **Overfitting risk** - Especially with high-dimensional microbiome data
- ‚ùå **Parameter tuning** - Many hyperparameters to optimize

**Limitations:**
- Requires substantial sample size for stable training
- Interpretability challenges for clinical PFS prediction
- Computational requirements may be prohibitive

**Why Choose:** Explores cutting-edge approaches for complex PFS correlation discovery.

**Expected PFS Correlations:** Complex non-linear relationships, potentially superior prediction

---

### **6. Functional Data Analysis for Longitudinal PFS Correlation**
**Implementation:** Analyzes microbial group trajectories over time in relation to PFS

**Description:** Models how microbial group abundances change over the transplant timeline and correlate with PFS outcomes.

**Mathematical Framework:**
```
x·µ¢(t) = Œº(t) + ‚àë_{k=1}^‚àû Œæ_{ik}œÜ_k(t) + Œµ·µ¢(t)
```
Where functions are expanded in basis functions, and correlated with PFS.

**Pros:**
- ‚úÖ **Temporal PFS dynamics** - Models how microbial changes correlate with PFS
- ‚úÖ **Longitudinal correlations** - Links entire trajectories to survival outcomes
- ‚úÖ **Smoothing** - Reduces noise in time-series microbial measurements
- ‚úÖ **Derivative analysis** - Can analyze rates of change correlated with PFS
- ‚úÖ **Sparsity handling** - Appropriate for irregular PFS/censoring patterns

**Cons:**
- ‚ùå **Data requirements** - Needs multiple timepoints per patient
- ‚ùå **Complexity** - Requires specialized statistical knowledge
- ‚ùå **Computational cost** - Functional methods are computationally intensive
- ‚ùå **Assumption dependence** - Basis function and smoothing parameter selection

**Limitations:**
- Requires longitudinal study design
- May not be applicable with only pre/post transplant PFS data

**Why Choose:** Provides temporal context for PFS correlations, linking microbial recovery patterns to long-term outcomes.

**Expected PFS Correlations:** Time-varying hazard ratios, trajectory-PFS relationships

---

### **7. Canonical Correlation Analysis (CCA) for Multimodal Integration**
**Implementation:** Finds linear combinations of microbial groups and clinical variables that are maximally correlated

**Description:** Identifies coordinated variation patterns between microbial groups and clinical variables, revealing multimodal PFS relationships.

**Mathematical Foundation:**
```
Maximize: corr(a·µÄG, b·µÄC)
Subject to: a·µÄG¬∑G·µÄa = 1, b·µÄC¬∑C·µÄb = 1
```
Where G = microbial groups, C = clinical variables.

**Pros:**
- ‚úÖ **Multimodal integration** - Links microbiome and clinical data
- ‚úÖ **Systems approach** - Reveals coordinated variation patterns
- ‚úÖ **Interpretable modes** - Each canonical variate represents a relationship mode
- ‚úÖ **Sparse extensions** - Can identify key contributing variables
- ‚úÖ **Clinical translation** - Directly relates to patient characteristics

**Cons:**
- ‚ùå **Complexity** - Requires optimization of canonical correlations
- ‚ùå **Parameter sensitivity** - Number of canonical variates affects results
- ‚ùå **Interpretability challenges** - Canonical variates are linear combinations
- ‚ùå **Assumption dependence** - Requires adequate sample size for stable estimates

**Limitations:**
- Requires both microbiome and clinical data for all samples
- Sensitive to scaling of different data types
- May find spurious correlations in high-dimensional data

**Why Choose:** Provides systems-level understanding of microbiome-clinical-PFS relationships.

**Expected PFS Correlations:** Canonical correlations between microbial and clinical patterns

---

### **8. Dirichlet Multinomial Regression**
**Implementation:** Statistical model specifically designed for microbiome compositional data

**Description:** Models microbial group abundances as Dirichlet-multinomial distributed, accounting for the compositional nature of microbiome data.

**Mathematical Foundation:**
```
f(y|œÄ, Œ∏) = ‚àè_{j=1}^D [Œì(N‚±º + Œ∏œÄ‚±º) / Œì(Œ∏œÄ‚±º)] / [Œì(N + Œ∏) / Œì(Œ∏)]
```
Where œÄ represents group proportions, Œ∏ is overdispersion.

**Pros:**
- ‚úÖ **Compositionally aware** - Properly handles relative abundance constraints
- ‚úÖ **Microbiome-specific** - Designed for sequencing count data characteristics
- ‚úÖ **Zero handling** - Naturally accommodates sparse microbiome data
- ‚úÖ **Ecologically meaningful** - Models community composition directly
- ‚úÖ **Statistical rigor** - Proper probabilistic framework for microbiome data

**Cons:**
- ‚ùå **Complexity** - More complex than standard regression approaches
- ‚ùå **Parameter estimation** - Requires specialized algorithms
- ‚ùå **Limited software** - Fewer implementations available
- ‚ùå **Computational cost** - More intensive than standard methods
- ‚ùå **Interpretability** - Results harder to interpret biologically

**Limitations:**
- Assumes Dirichlet distribution for group proportions
- May not handle extreme sparsity well
- Requires larger sample sizes for stable estimates

**Why Choose:** Provides statistically rigorous modeling of microbiome group-PFS relationships.

**Expected PFS Correlations:** Composition-aware hazard ratios for microbial groups

---

### **9. Bayesian Survival Models**
**Implementation:** Probabilistic modeling of PFS using Bayesian inference with microbial groups

**Description:** Uses Bayesian methods to model uncertainty in PFS correlations with microbial groups, providing probabilistic estimates.

**Mathematical Framework:**
```
P(Œ≤|data) ‚àù P(data|Œ≤) √ó P(Œ≤)
```
Where Œ≤ represents microbial group effects on PFS.

**Pros:**
- ‚úÖ **Uncertainty quantification** - Provides credible intervals for all estimates
- ‚úÖ **Prior knowledge integration** - Can incorporate biological knowledge
- ‚úÖ **Flexible modeling** - Can handle complex relationships and hierarchies
- ‚úÖ **Robust to small samples** - Bayesian methods work well with limited data
- ‚úÖ **Model comparison** - Built-in framework for comparing different models

**Cons:**
- ‚ùå **Computational intensity** - Requires MCMC sampling or variational inference
- ‚ùå **Parameter tuning** - Prior specification affects results
- ‚ùå **Convergence issues** - MCMC may not converge in complex models
- ‚ùå **Interpretability challenges** - Posterior distributions can be complex
- ‚ùå **Software complexity** - Requires specialized Bayesian software

**Limitations:**
- Requires expertise in Bayesian statistics
- Computational cost increases with model complexity
- Prior specification can be subjective
- Convergence diagnosis is non-trivial

**Why Choose:** Provides robust uncertainty quantification for PFS correlations in small datasets.

**Expected PFS Correlations:** Credible intervals for hazard ratios, probabilistic risk estimates

---

### **10. Ensemble Model Integration**
**Implementation:** Combines multiple MVA methods to create robust PFS correlation estimates

**Description:** Applies several MVA methods and integrates their results using ensemble techniques, providing comprehensive PFS correlation assessment.

**Algorithm:**
1. Apply multiple MVA methods (Cox, PLS, Random Forests, etc.)
2. Extract PFS correlation estimates from each method
3. Combine estimates using ensemble rules (averaging, weighted voting, stacking)
4. Assess consensus and uncertainty across methods

**Pros:**
- ‚úÖ **Robust estimation** - Combines strengths of different approaches
- ‚úÖ **Uncertainty quantification** - Assesses agreement across methods
- ‚úÖ **Method validation** - Cross-verification of correlation findings
- ‚úÖ **Comprehensive assessment** - Captures different types of relationships
- ‚úÖ **Improved reliability** - Reduces method-specific biases and errors

**Cons:**
- ‚ùå **Computational cost** - Running multiple complex methods
- ‚ùå **Result integration complexity** - Challenging to combine different outputs
- ‚ùå **Ensemble rule arbitrariness** - Different combination rules give different results
- ‚ùå **Interpretation difficulty** - More complex to interpret ensemble results
- ‚ùå **Resource intensive** - Requires significant computational resources

**Limitations:**
- Requires careful selection of which methods to ensemble
- Ensemble rules are somewhat subjective
- May mask important disagreements between methods
- Computational requirements multiply with number of methods

**Why Choose:** Provides the most comprehensive and reliable PFS correlation assessment.

**Expected PFS Correlations:** Consensus estimates with uncertainty quantification across methods

---

## üéØ Implementation Strategy

### **Recommended MVA Pipeline:**

#### **Primary Analysis (Implemented Method):**
```python
# Start with Cox regression (gold standard for PFS)
cox_model = CoxPHFitter()
cox_model.fit(final_groups + clinical_vars, duration_col='time', event_col='event')

# Basic validation
cox_summary = cox_model.summary
significant_groups = cox_summary[cox_summary['p'] < 0.05]
```

#### **Extended Analysis (Suggested Methods):**
```python
# Add complementary methods for validation
pls_model = fit_pls_survival(final_groups, pfs_data)  # Not implemented
rf_model = fit_random_survival_forest(final_groups + clinical_vars, pfs_data)  # Not implemented

# Compare results across methods
comparison_results = compare_mva_methods([cox_model, pls_model, rf_model])
```

#### **Advanced Implementation (Future Development):**
```python
# Ensemble approach for robust predictions
ensemble_predictions = create_ensemble_model([cox_model, pls_model, rf_model])
calibrated_predictions = calibrate_predictions(ensemble_predictions, validation_data)
```

### **Method Selection Guidelines:**

#### **Choose Cox Regression If:**
- Primary goal is clinical interpretability and hazard ratios
- Need to control for clinical covariates
- Sample size is moderate (n=50-500)
- Censoring rate is reasonable (<30%)

#### **Add PLS Regression If:**
- Want to handle multicollinear microbial groups
- Need variable importance scores
- Data has high dimensionality relative to sample size
- Interested in latent microbial patterns

#### **Add Random Forests If:**
- Suspect non-linear relationships between microbes and PFS
- Want to capture complex interactions
- Data is high-dimensional
- Need robust, overfitting-resistant predictions

#### **Add Neural Networks If:**
- Have large sample size (n>500)
- Suspect very complex non-linear relationships
- Want state-of-the-art predictive performance
- Have computational resources for training

### **Success Metrics:**

#### **Statistical Performance:**
- **PFS Correlation Strength:** Hazard ratios >2.0 for significant groups
- **Significance Level:** p < 0.05 after multiple testing correction
- **Model Fit:** AIC/BIC improvement over null models
- **Cross-validation:** AUROC >0.75 on held-out data

#### **Clinical Relevance:**
- **Risk Stratification:** Clear separation between high/low-risk groups
- **Clinical Variables:** Microbial effects independent of known clinical factors
- **Biological Plausibility:** Associations supported by mechanistic evidence
- **Actionable Results:** Clear implications for patient management

#### **Robustness:**
- **Method Consistency:** Similar results across different MVA approaches
- **Parameter Stability:** Results robust to parameter variations
- **Sample Stability:** Consistent findings across data subsets
- **External Validation:** Replicable in independent cohorts

### **Validation Approach:**

#### **Internal Validation:**
- **Cross-validation:** k-fold CV with AUROC, Brier score assessment
- **Bootstrap validation:** Confidence intervals for hazard ratios
- **Sensitivity analysis:** Test robustness to parameter choices
- **Subgroup analysis:** Validate in clinical subgroups

#### **External Validation:**
- **Independent cohort:** Test on separate patient population
- **Temporal validation:** Test on more recent patients
- **Geographic validation:** Test across different institutions
- **Platform validation:** Test across different sequencing technologies

#### **Clinical Validation:**
- **Clinical correlation:** Compare with established clinical biomarkers
- **Outcome prediction:** Assess calibration of predicted vs observed PFS
- **Decision curve analysis:** Evaluate clinical utility
- **Cost-effectiveness:** Assess value for clinical decision-making

### **Troubleshooting Common Issues:**

#### **Model Convergence Problems:**
- Add regularization (penalizer parameter in lifelines)
- Check for multicollinearity between groups
- Reduce number of groups or use dimensionality reduction first
- Scale/normalize group features appropriately

#### **Low Predictive Performance:**
- Check if groups are truly PFS-relevant (revisit group selection)
- Add more clinical covariates
- Consider interaction terms between groups
- Try different MVA methods (ensemble approaches often perform better)

#### **Implausible Hazard Ratios:**
- Check for data quality issues (outliers, measurement errors)
- Verify group construction is biologically meaningful
- Consider confounding by clinical variables
- Validate against univariate analyses

#### **Inconsistent Results Across Methods:**
- This may indicate weak signals or methodological artifacts
- Focus on results consistent across multiple methods
- Revisit group construction or variable selection
- Consider simpler models if complex methods disagree

This multivariate PFS correlation analysis transforms microbial groups into clinically actionable PFS biomarkers with comprehensive statistical validation, biological interpretation, and clinical translation potential.