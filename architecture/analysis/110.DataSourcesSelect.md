# 110.DataSourcesSelect.md: Data Source Selection and Timepoint/Delta Configuration

## üéØ Overview

**Data Source Selection and Timepoint/Delta Configuration** is the foundational step that establishes which specific microbial timepoint or delta analysis will be performed in this pipeline run. This step integrates patient clinical data with taxonomic classifications and selects the specific microbial abundance data (baseline timepoint, follow-up timepoint, or calculated delta) for analysis.

## üìã Purpose

- **Timepoint Selection**: Choose which microbial timepoint (pre-treatment, 2 months post-treatment, 24 months post-treatment) or delta (changes between timepoints) to analyze
- **Data Integration Setup**: Establish connections between patient clinical data, taxonomic classifications, and selected microbial abundance data
- **Analysis Focus**: Define whether this analysis examines absolute abundances at a specific timepoint or changes over time
- **Pipeline Foundation**: Ensure data compatibility and establish the analytical scope for all downstream steps

## üîß Configuration Options

### **Required Data Files**

#### **1. Patient Data File**
**File Type**: CSV, TSV, or Excel format
**Content**: Clinical metadata for all patients in the study
**Required Columns**:
- Patient identifier (e.g., ENG followed by numbers)
- Clinical outcomes (Progression-Free Survival - PFS)
- Timepoint information (Pre-transplant, Engraftment, 24 months)
- Demographic and clinical variables
- Study origin information (CP48 vs MSK)

**Validation Checks**:
- Patient IDs must be unique and properly formatted
- PFS data must be numeric and non-negative
- Timepoint values must match expected categories
- Study origin must be specified for multi-study datasets

#### **2. Taxonomy Data File**
**File Type**: CSV format
**Content**: Mapping between Operational Taxonomic Units (OTUs) and taxonomic classifications
**Required Columns**:
- `OTU`: Sequential numeric identifier (1, 2, 3, ...)
- `Taxonomy`: Full taxonomic classification (semicolon-separated)

**Taxonomy Format**:
```
Domain;Phylum;Class;Order;Family;Genus;Species
```

**Validation Checks**:
- OTU IDs must be unique integers starting from 1
- Taxonomy strings must follow semicolon format
- No missing or "Unclassified" entries at high taxonomic levels

#### **3. Bracken Results File (Combined Timepoints)**
**File Type**: TXT format (tab-separated)
**Content**: Combined taxonomic abundance estimates from Bracken metagenomic profiling across all timepoints
**Structure**:
- First column: Taxon name
- Subsequent columns: Sample abundance values from all timepoints
- Sample names include timepoint identifiers (e.g., ENG001_P, ENG001_E, ENG001_24M)
- Header row with sample identifiers

**Validation Checks**:
- Sample names must follow timepoint naming convention
- Abundance values must be numeric and non-negative
- Taxa names must be consistent with taxonomy file
- File must contain data for multiple timepoints per patient

## üéØ **Timepoint/Delta Selection**

### **Available Analysis Types**

#### **1. Single Timepoint Analysis**
**Options**:
- **Pre-treatment** (baseline): Microbial composition before transplant
- **2 months post-treatment** (early post-transplant): Early engraftment/recovery
- **24 months post-treatment** (late post-transplant): Long-term microbiome stabilization

**Use Case**: Examine microbial composition at a specific clinical timepoint to identify biomarkers for that stage

#### **2. Delta Analysis (Changes Over Time)**
**Options**:
- **Pre-treatment ‚Üí 2 months**: Early transplant recovery dynamics
- **Pre-treatment ‚Üí 24 months**: Long-term transplant impact
- **2 months ‚Üí 24 months**: Late microbiome evolution

**Use Case**: Identify microbial changes associated with treatment response or disease progression

### **Selection Configuration**
```python
TIMEPOINT_CONFIGURATIONS = {
    'pre_treatment': {
        'name': 'Pre-treatment Baseline',
        'description': 'Microbial composition before transplant',
        'timepoint_filter': '_P$|_A$',  # Pre-transplant samples
        'clinical_focus': 'Pre-transplant risk assessment'
    },
    '2m_post_treatment': {
        'name': '2 Months Post-treatment',
        'description': 'Early post-transplant microbiome recovery',
        'timepoint_filter': '_E$',  # Engraftment samples
        'clinical_focus': 'Early transplant recovery'
    },
    '24m_post_treatment': {
        'name': '24 Months Post-treatment',
        'description': 'Long-term microbiome stabilization',
        'timepoint_filter': '_24M$|_2-4M$',  # 24-month samples
        'clinical_focus': 'Long-term transplant outcomes'
    },
    'delta_pre_to_2m': {
        'name': 'Pre-treatment to 2 Months Delta',
        'description': 'Early microbial changes post-transplant',
        'delta_calculation': 'baseline_to_early',
        'clinical_focus': 'Early transplant response'
    },
    'delta_pre_to_24m': {
        'name': 'Pre-treatment to 24 Months Delta',
        'description': 'Long-term microbial changes post-transplant',
        'delta_calculation': 'baseline_to_late',
        'clinical_focus': 'Long-term transplant impact'
    },
    'delta_2m_to_24m': {
        'name': '2 Months to 24 Months Delta',
        'description': 'Late microbiome evolution',
        'delta_calculation': 'early_to_late',
        'clinical_focus': 'Late microbiome stabilization'
    }
}
```

## üîÑ Data Processing Logic

### **Timepoint Extraction**
For single timepoint selection:
1. **Filter Samples**: Extract samples matching the selected timepoint pattern
2. **Patient Matching**: Ensure each patient has data for the selected timepoint
3. **Data Preparation**: Create analysis-ready abundance matrix for selected timepoint

### **Delta Calculation**
For delta analysis:
1. **Baseline Identification**: Extract pre-treatment abundances for each patient
2. **Follow-up Identification**: Extract post-treatment abundances for each patient
3. **Delta Computation**: Calculate abundance changes using specified method
4. **Validation**: Ensure paired samples exist for delta calculation

### **Delta Calculation Methods**
- **Absolute Difference**: `Œî = Post - Pre`
- **Relative Change**: `Œî = (Post - Pre) / Pre`
- **Log Fold Change**: `Œî = log‚ÇÇ(Post / Pre)`
- **Percent Change**: `Œî = ((Post - Pre) / Pre) √ó 100`

## üìä Integration with Pipeline

### **Downstream Dependencies**
- **Data Curation**: Receives selected timepoint/delta data for quality control
- **Variable Selection**: Analyzes microbial features from selected timepoint/delta
- **MVA Methods**: Correlates selected microbial data with PFS outcomes
- **Output Generation**: Presents results specific to selected timepoint/delta

### **Pipeline Impact**
- **Analysis Scope**: Defines whether results apply to absolute abundances or changes over time
- **Clinical Interpretation**: Results contextualized to selected timepoint/delta
- **Comparative Analysis**: Enables cross-timepoint comparisons via TimePointsComparison module

## üéØ Selection Criteria

### **Timepoint Selection Guidelines**
- **Pre-treatment**: When studying baseline microbial risk factors
- **2 months post-treatment**: When examining early transplant recovery and engraftment
- **24 months post-treatment**: When studying long-term microbiome stabilization and late outcomes

### **Delta Selection Guidelines**
- **Pre ‚Üí 2 months**: Focus on immediate transplant effects and early complications
- **Pre ‚Üí 24 months**: Comprehensive transplant impact assessment
- **2m ‚Üí 24m**: Late microbiome evolution and stabilization patterns

## ‚ö†Ô∏è Common Issues and Solutions

### **Missing Timepoint Data**
- **Issue**: Not all patients have samples at selected timepoint
- **Solution**: Patient exclusion or imputation strategies during data curation

### **Delta Calculation Errors**
- **Issue**: Missing paired samples for delta computation
- **Solution**: Implement robust pairing logic and handle missing data appropriately

### **Timepoint Misclassification**
- **Issue**: Incorrect timepoint assignment from sample naming
- **Solution**: Implement strict regex validation and manual review of ambiguous cases

## üîç Quality Control

### **Automated Validation**
- Timepoint extraction accuracy verification
- Delta calculation validation (paired sample integrity)
- Patient coverage assessment across selected timepoint/delta
- Abundance data quality checks for selected subset

### **Manual Review**
- Sample selection logic verification
- Delta calculation method appropriateness
- Clinical relevance of selected timepoint/delta
- Coverage statistics across patient subgroups

## üìà Expected Outcomes

### **Single Timepoint Analysis**
- Microbial abundance matrix for selected timepoint
- Patient coverage statistics
- Timepoint-specific quality metrics

### **Delta Analysis**
- Delta abundance matrix showing changes
- Paired sample statistics
- Change distribution summaries

This foundational step establishes the analytical focus (timepoint vs delta) for the entire pipeline, ensuring all subsequent analyses are appropriately contextualized to the selected microbial measurement type and clinical timepoint.